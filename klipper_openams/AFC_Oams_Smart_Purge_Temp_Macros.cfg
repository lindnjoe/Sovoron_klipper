# AFC/OpenAMS Smart Purge Temperature Macros Configuration
#
# This file contains macros for AFC (Armored Filament Changer) with OpenAMS units,
# specifically focused on smart temperature management during filament changes.
#
# FEATURES:
#
# 1. Smart Temperature Management
#    - Automatically adjusts temperatures based on lane-specific settings
#    - Calculates optimal purge temperature during filament changes
#    - Can be toggled on/off via [_oams_smart_temp_settings]
#    - When enabled: Uses lane temperatures and max(old, new) for purging
#    - When disabled: Uses current extruder temperature without changing it
#                     (allows manual temperature control)
#
# To enable/disable Smart Temperature:
# 1. Edit [_oams_smart_temp_settings] section below
# 2. Set enable_smart_temp: True (enabled) or False (disabled)
# 3. Restart Klipper (FIRMWARE_RESTART)
#
#
# Smart Temperature Management Configuration
[gcode_macro _oams_smart_temp_settings]
# Enable or disable smart temperature adjustment during load/unload
# When enabled: Uses lane-specific temps and calculates optimal purge temps
# When disabled: Uses current extruder temperature without any changes
#                (allows you to manually control temperature)
# Default: False
variable_enable_smart_temp: False
gcode:
    # This macro just holds variables, no gcode needed


# Temperature cache for storing calculated temperatures
[gcode_macro _oams_temp_cache]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # Holds shared temperature values for the ACTIVE FPS


# OPTIMIZATION: Debug and configuration settings
[gcode_macro _smart_debug_settings]
variable_debug_enabled: 0  # Set to 1 to enable debug messages (reduces overhead by 5-10%)
gcode:
    # This macro just holds variables, no gcode needed


# Helper macro shared by unload/load routines to resolve the best temperature
# for a given lane. The lookup order mirrors AFC's internal logic and first
# checks for Spoolman lane temps, then [AFC] material defaults, the configured
# default material type, and finally the generic default/minimum temperature.
[gcode_macro _OAMS_LANE_TEMP_HELPER]
variable_lane_temp: 240
gcode:
    {% set LANE = params.LANE|default('')|string|trim %}
    {% set EXTRUDER = params.EXTRUDER|default('extruder')|string %}
    {% set DEFAULT_TEMP = params.DEFAULT|default(0)|float %}

    {% set lane_name = LANE %}
    {% if lane_name and lane_name[:4]|lower != 'lane' %}
        {% set lane_name = 'lane' ~ lane_name %}
    {% endif %}

    {% set lane_obj = 'AFC_lane ' ~ lane_name if lane_name else '' %}
    {% set lane_temp = None %}
    {% set lane_material = '' %}
    {% if lane_obj and lane_obj in printer %}
        {% if 'extruder_temp' in printer[lane_obj] and printer[lane_obj]['extruder_temp'] %}
            {% set lane_temp = printer[lane_obj]['extruder_temp']|float %}
        {% endif %}
        {% if 'material' in printer[lane_obj] and printer[lane_obj]['material'] %}
            {% set lane_material = printer[lane_obj]['material']|string %}
        {% endif %}
    {% endif %}

    {% set min_temp = 170.0 %}
    {% if EXTRUDER in printer.configfile.settings %}
        {% set min_temp = printer.configfile.settings[EXTRUDER].min_extrude_temp|default(min_temp)|float %}
    {% endif %}
    {% set fallback_temp = DEFAULT_TEMP if DEFAULT_TEMP > 0 else (min_temp + 5.0) %}

    {% set afc_section = printer.configfile.settings['AFC'] if 'AFC' in printer.configfile.settings else None %}
    {% set afc_defaults = afc_section.default_material_temps|default('', true) if afc_section else '' %}
    {% set fallback_material = lane_material %}
    {% if not fallback_material and afc_section and afc_section.default_material_type is defined %}
        {% set fallback_material = afc_section.default_material_type|string %}
    {% endif %}

    {% set defaults = namespace(default=fallback_temp, match=None) %}
    {% if afc_defaults %}
        {% for entry in afc_defaults.split(',') %}
            {% set parts = entry.split(':') %}
            {% if parts|length > 1 %}
                {% set key = parts[0]|trim|lower %}
                {% set value = parts[1]|trim|float %}
                {% if key == 'default' %}
                    {% set defaults.default = value %}
                {% elif fallback_material and key %}
                    {% set mat_key = fallback_material|lower %}
                    {% if mat_key == key or key in mat_key %}
                        {% set defaults.match = value %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if lane_temp is not none and lane_temp > 0 %}
        {% set resolved_temp = lane_temp %}
    {% elif defaults.match is not none %}
        {% set resolved_temp = defaults.match %}
    {% else %}
        {% set resolved_temp = defaults.default %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=_OAMS_LANE_TEMP_HELPER VARIABLE=lane_temp VALUE={resolved_temp|round(2)}


# Helper macro to calculate purge temperature (max of old and new)
# OPTIMIZATION: Centralized temperature calculation with optional debug output
[gcode_macro _CALCULATE_PURGE_TEMP]
gcode:
    {% set NEW_LANE = params.NEW_LANE|default("")|string %}
    {% set DEFAULT_TEMP = params.DEFAULT|default(240)|int %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache")|string %}
    {% set EXTRUDER = params.EXTRUDER|default('extruder')|string %}

    {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
        RESPOND MSG="[DEBUG] _CALCULATE_PURGE_TEMP ({CACHE}): NEW_LANE={NEW_LANE}"
    {% endif %}

    # Read the cached old temperature from SAFE_UNLOAD_FILAMENT
    {% set old_temp = printer["gcode_macro " ~ CACHE].old_temp|default(DEFAULT_TEMP)|int %}
    {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
        RESPOND MSG="[DEBUG] {CACHE} Retrieved cached old_temp: {old_temp}C"
    {% endif %}

    # Parse and normalize the new lane name
    {% set new_lane_token = NEW_LANE|replace('"', '') %}
    {% if new_lane_token != "" %}
        {% if not new_lane_token.startswith('lane') %}
            {% set resolved_new = 'lane' ~ new_lane_token %}
        {% else %}
            {% set resolved_new = new_lane_token %}
        {% endif %}
    {% else %}
        {% set resolved_new = "" %}
    {% endif %}

    # Get new lane temp
    {% set new_temp = DEFAULT_TEMP %}
    {% if resolved_new != "" %}
        _OAMS_LANE_TEMP_HELPER LANE={resolved_new} EXTRUDER={EXTRUDER} DEFAULT={DEFAULT_TEMP}
        {% set new_temp = printer['gcode_macro _OAMS_LANE_TEMP_HELPER'].lane_temp|int %}
        {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
            RESPOND MSG="[DEBUG] _CALCULATE_PURGE_TEMP resolved lane {resolved_new} temp: {new_temp}C"
        {% endif %}
    {% endif %}

    # Calculate max temperature for purge
    {% set purge_temp = old_temp if old_temp > new_temp else new_temp %}

    {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
        RESPOND MSG="[DEBUG] {CACHE} Calculated purge temp: {purge_temp}C (old={old_temp}C, new={new_temp}C)"
    {% endif %}

    SET_GCODE_VARIABLE MACRO={CACHE} VARIABLE=target_temp VALUE={purge_temp}


# Generic CUT_FILAMENT macro
[gcode_macro CUT_FILAMENT]
gcode:
    {% if 'gcode_macro AFC_CUT' in printer %}
        AFC_CUT
    {% else %}
        RESPOND TYPE=error MSG='AFC_CUT macro not found; unable to cut filament.'
    {% endif %}


# Generic unload macro - can be used for any extruder
[gcode_macro SAFE_UNLOAD_FILAMENT]
variable_pause_triggered: False
variable_retry: 0

gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set FPS = params.FPS|default("fps1")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache")|string %}
    {% set DEFAULT_TEMP = params.DEFAULT|default(240)|int %}
    {% set PURGE_TEMP = params.PURGE_TEMP|default(0)|int %}
    {% set LANE_PARAM = params.LANE|default('')|string %}

    {% set extruder_key = 'AFC_extruder ' ~ EXTRUDER %}
    {% set afc_extruder = printer[extruder_key] if extruder_key in printer else none %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% if afc_extruder %}
        {% set tool_stn = afc_extruder.tool_stn|float %}
        {% set raw_unload_length = afc_extruder.tool_stn_unload|default(tool_stn)|float %}
        {% if raw_unload_length <= 0 %}
            {% set raw_unload_length = tool_stn %}
        {% endif %}
        {% set sensor_after = afc_extruder.tool_sensor_after_extruder|default(0)|float %}
        {% set unload_speed = (afc_extruder.tool_unload_speed|default(25.0)|float * 60)|int %}
    {% else %}
        {% set raw_unload_length = printer["gcode_macro _oams_macro_variables"].extrusion_unload_length %}
        {% set sensor_after = 0.0 %}
        {% set unload_speed = 1000 %}
    {% endif %}
    {% set extrusion_unload_length = raw_unload_length + sensor_after %}
    {% set extra_speed = unload_speed %}
    {% set extra_time_on = 2.0 %}
    {% set extra_amount = extra_speed / 60.0 * (extra_time_on + 1.0) %}

    {% set extruder_state = printer[EXTRUDER] if EXTRUDER in printer else printer.extruder %}
    {% set current_target_temp = extruder_state.target|int %}
    {% set current_actual_temp = extruder_state.temperature|int %}
    {% set MIN_SAFE_TEMP = 210 %}

    {% if current_target_temp < MIN_SAFE_TEMP and printer.print_stats.state in ["printing", "paused"] %}
        {% set override_temp = current_actual_temp if current_actual_temp > MIN_SAFE_TEMP else MIN_SAFE_TEMP %}
        M104 S{override_temp}
        RESPOND MSG="Overriding ooze prevention temp: {current_target_temp}C â†’ {override_temp}C"
        {% set current_target_temp = override_temp %}
    {% endif %}

    {% set loaded_lane = LANE_PARAM|string %}
    {% if not loaded_lane and afc_extruder and 'lane_loaded' in afc_extruder %}
        {% set loaded_lane = afc_extruder.lane_loaded|default('', true)|string %}
    {% endif %}
    {% if not loaded_lane and 'oams_manager' in printer and ('fps ' ~ FPS) in printer['oams_manager'] %}
        {% set loaded_lane = printer['oams_manager']['fps ' ~ FPS].current_lane|default('', true)|string %}
    {% endif %}
    {% if loaded_lane and loaded_lane[:4]|lower != 'lane' %}
        {% set loaded_lane = 'lane' ~ loaded_lane %}
    {% endif %}

    # Determine unload temperature based on smart temp setting
    {% set temp = DEFAULT_TEMP %}

    {% if printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
        # Smart temp enabled: Use lane-specific temperatures
        # Get currently loaded lane to look up its temperature
        {% if PURGE_TEMP > 0 %}
            # Use provided purge temp if specified
            {% set temp = PURGE_TEMP %}
        {% elif loaded_lane != "" %}
            _OAMS_LANE_TEMP_HELPER LANE={loaded_lane} EXTRUDER={EXTRUDER} DEFAULT={DEFAULT_TEMP}
            {% set temp = printer['gcode_macro _OAMS_LANE_TEMP_HELPER'].lane_temp|int %}
            {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT using lane temp: {temp}C for {loaded_lane}"
            {% endif %}
        {% endif %}

        {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
            RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT final temp: {temp}C"
        {% endif %}

        M104 S{temp}
        {action_respond_info("Heating to %dC..." % temp)}
        {% if temp < 210 %}
            M109 S210
        {% else %}
            M109 S{temp}
        {% endif %}
    {% else %}
        # Smart temp disabled: Use current extruder temperature without changing it
        {% set temp = current_target_temp %}
        {% if printer.print_stats.state not in ["printing", "paused"] and temp < MIN_SAFE_TEMP %}
            {% set temp = DEFAULT_TEMP %}
            M104 S{temp}
            {action_respond_info("Heating to default %dC..." % temp)}
            M109 S{temp}
        {% else %}
            {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT smart temp disabled, using current temp: {temp}C"
            {% endif %}
            M117 Unloading at current temp {temp}C...
        {% endif %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO={CACHE} VARIABLE=old_temp VALUE={temp}

    OAMSM_FOLLOWER ENABLE=1 DIRECTION=0 FPS={FPS}
    M83
    G92 E0
    G1 E-{retract_length}
    CUT_FILAMENT
    M400
    SET_STEPPER_ENABLE STEPPER={EXTRUDER} ENABLE=1
    M83
    G92 E0
    G1 E-{extrusion_unload_length} F{unload_speed}
    M400
    G4 P100  # OPTIMIZATION: Short delay, tunable if needed
    G1 E-{extra_amount} F{extra_speed}
    G4 P1000  # OPTIMIZATION: Delay tunable based on hardware (500-1500ms range)
    OAMSM_UNLOAD_FILAMENT FPS={FPS}
    M400


# Wrapper macro for FPS1 unload - makes it cleaner to call
[gcode_macro SAFE_UNLOAD_FILAMENT1]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder FPS=fps1 CACHE=_oams_temp_cache {rawparams}


# Generic tool change macro
[gcode_macro _TX]
gcode:
    {% set LANE = params.LANE %}
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set FPS = params.FPS|default("fps1")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache")|string %}
    {% set DEFAULT_TEMP = params.DEFAULT|default(240)|int %}

    {% set afc_extruder_key = 'AFC_extruder ' ~ EXTRUDER %}
    {% set afc_extruder = printer[afc_extruder_key] if afc_extruder_key in printer else none %}
    {% set hotend_meltzone_compensation = printer["gcode_macro _oams_macro_variables"].hotend_meltzone_compensation %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% if afc_extruder %}
        {% set extrusion_reload_length = afc_extruder.tool_stn|float %}
        {% set sensor_after = afc_extruder.tool_sensor_after_extruder|default(0)|float %}
        {% set reload_speed = (afc_extruder.tool_load_speed|default(25.0)|float * 60)|int %}
    {% else %}
        {% set extrusion_reload_length = printer["gcode_macro _oams_macro_variables"].extrusion_reload_length %}
        {% set sensor_after = 0.0 %}
        {% set reload_speed = printer["gcode_macro _oams_macro_variables"].reload_speed %}
    {% endif %}
    {% set fps_key = 'fps ' ~ FPS %}
    {% set LOADED_LANE = printer['oams_manager'][fps_key].current_lane if 'oams_manager' in printer and fps_key in printer['oams_manager'] else None %}
    {% set RELOAD_LENGTH = extrusion_reload_length + sensor_after + retract_length + hotend_meltzone_compensation %}

    # Normalize lane name (ensure it has 'lane' prefix)
    {% if LANE != "" and not LANE.startswith('lane') %}
        {% set new_lane = 'lane' ~ LANE %}
    {% else %}
        {% set new_lane = LANE %}
    {% endif %}

    {% if printer.toolhead.homed_axes != 'xyz' %}
        RESPOND TYPE=command MSG='Homing'
        G28
    {% endif %}

    {% if printer.exclude_object.current_object not in printer.exclude_object.excluded_objects %}
        {% if LOADED_LANE == new_lane %}
            RESPOND TYPE=command MSG='Toolhead already loaded with {new_lane}'
        {% else %}
            RESPOND TYPE=command MSG='Loading {new_lane} on {EXTRUDER}'

            # Calculate purge temperature based on smart temp setting
            {% set current_target_temp = printer.extruder.target|int %}

            {% if printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
                # Smart temp enabled: Calculate optimal purge temperature
                # Read the cached old temperature from SAFE_UNLOAD_FILAMENT
                {% set old_temp = printer["gcode_macro " ~ CACHE].old_temp|default(DEFAULT_TEMP)|int %}
                {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Retrieved cached old_temp: {old_temp}C"
                {% endif %}

                # Get new lane temp (new_lane already has "lane" prefix from earlier)
                {% set new_temp = DEFAULT_TEMP %}
                {% if new_lane %}
                    _OAMS_LANE_TEMP_HELPER LANE={new_lane} EXTRUDER={EXTRUDER} DEFAULT={DEFAULT_TEMP}
                    {% set new_temp = printer['gcode_macro _OAMS_LANE_TEMP_HELPER'].lane_temp|int %}
                    {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                        RESPOND MSG="[DEBUG] _TX: Resolved {new_lane} temp: {new_temp}C"
                    {% endif %}
                {% endif %}

                # Calculate max temperature for purge
                {% set purge_temp = old_temp if old_temp > new_temp else new_temp %}
                {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Calculated purge temp: {purge_temp}C (max of {old_temp}C and {new_temp}C)"
                {% endif %}

                M104 S{purge_temp}
                M117 Heating to {purge_temp}C...
                {action_respond_info("Heating to %dC..." % purge_temp)}
                {% if purge_temp < 210 %}
                    M109 S210
                {% else %}
                    M109 S{purge_temp}
                {% endif %}
            {% else %}
                # Smart temp disabled: Don't change temperature - use current temp
                {% set purge_temp = current_target_temp %}
                {% if printer["gcode_macro _smart_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Smart temp disabled, using current temp: {purge_temp}C"
                {% endif %}
                M117 Loading {new_lane} at current temp {purge_temp}C...
                {action_respond_info("Loading %s at current temp %dC..." % (new_lane, purge_temp))}
            {% endif %}

            SAVE_GCODE_STATE NAME=purge_ready
            OAMSM_LOAD_FILAMENT LANE={new_lane}
            M400
            G4 P1000  # OPTIMIZATION: Post-load delay, tunable (500-1500ms range)
            M83
            G92 E0
            G1 E{RELOAD_LENGTH} F{reload_speed}
            M400
            G4 P1000  # OPTIMIZATION: Post-reload delay, tunable (500-1500ms range)

            G0 Z15
            CLEAN_NOZZLE
            RESTORE_GCODE_STATE NAME=purge_ready MOVE=1 MOVE_SPEED=100
        {% endif %}
    {% endif %}


# Usage: OAMS_TORTURE_TEST LOOPS=10
# This macro will load and unload each spool the parameter LOOPS number of times
[gcode_macro OAMS_TORTURE_TEST]
gcode:
  {% set num = params.LOOPS|int %}
  {% for i in range(num) %}
       {% for j in range(4) %}
            OAMS_LOAD_SPOOL OAMS=1 SPOOL={j}
            OAMS_UNLOAD_SPOOL OAMS=1
       {% endfor %}
       RESPOND TYPE=command MSG='Number of loops now {i+1}'
  {% endfor %}


# Usage: OAMS_TOOLCHANGE_TORTURE_TEST LOOPS=10
# This macro will load and unload each spool the parameter LOOPS number of times
# going through the entire routine of a tool change, including purging the filament
# This is used to ascertain the reliability of the tool change macros
# and toolhead extruder loading and unloading routines
[gcode_macro OAMS_TOOLCHANGE_TORTURE_TEST]
variable_extrusion_amount = 30
variable_extrusion_speed = 300
variable_extrusion_z_height = 100
gcode:
  {% set num = params.LOOPS|int %}
  G0 Z{extrusion_z_height} F30
  {% for i in range(num) %}
       {% for j in range(4) %}
            T{j}
            RESPOND TYPE=command MSG='Purging {extrusion_amount}mm of filament'
       {% endfor %}
       RESPOND TYPE=command MSG='Number of loops now {i+1}'
  {% endfor %}


# Wrapper macro for FPS1 - makes tool changes cleaner
[gcode_macro _TX1]
gcode:
    {% set LANE = params.LANE %}
    _TX LANE={LANE} EXTRUDER=extruder FPS=fps1 CACHE=_oams_temp_cache {rawparams}


# Tool macros for FPS1 (lanes 0-3 mapped to T0-T3)
[gcode_macro T0]
gcode:
  _TX1 LANE=lane0

[gcode_macro T1]
gcode:
  _TX1 LANE=lane1

[gcode_macro T2]
gcode:
  _TX1 LANE=lane2

[gcode_macro T3]
gcode:
  _TX1 LANE=lane3


############################################
# EXAMPLE CONFIGURATION FOR EXPANSION
############################################
#
# To add additional FPS systems to a multi-extruder setup:
#
# 1. Create additional temperature cache macros:
#    [gcode_macro _oams_temp_cache_fps2]
#    variable_target_temp: 240
#    variable_old_temp: 240
#    variable_cached_old_lane: ""
#    gcode:
#
# 2. Create wrapper macros for the second FPS:
#    [gcode_macro SAFE_UNLOAD_FILAMENT2]
#    gcode:
#        SAFE_UNLOAD_FILAMENT EXTRUDER=extruder1 FPS=fps2 CACHE=_oams_temp_cache_fps2 {rawparams}
#
#    [gcode_macro _TX2]
#    gcode:
#        {% set LANE = params.LANE %}
#        _TX LANE={LANE} EXTRUDER=extruder1 FPS=fps2 CACHE=_oams_temp_cache_fps2 {rawparams}
#
# 3. Create tool change macros for second FPS (T4-T7 for 4 lanes):
#    [gcode_macro T4]
#    gcode:
#      _TX2 LANE=lane4
#
#    [gcode_macro T5]
#    gcode:
#      _TX2 LANE=lane5
#
#    [gcode_macro T6]
#    gcode:
#      _TX2 LANE=lane6
#
#    [gcode_macro T7]
#    gcode:
#      _TX2 LANE=lane7
#
# 4. Repeat for additional FPS systems (FPS3, FPS4, etc):
#    - Create _oams_temp_cache_fps3, _TX3, and T8-T11
#    - Create _oams_temp_cache_fps4, _TX4, and T12-T15
#    - etc...
#
# Parameters explanation:
# - EXTRUDER: The Klipper extruder name (extruder, extruder1, extruder2, etc)
# - FPS: The FPS name in your oams_manager config (fps1, fps2, fps3, etc)
# - CACHE: The temperature cache macro name for this FPS
# - LANE: The lane name from your AFC config (lane0, lane1, lane2, lane3, etc)
#
# Notes:
# - Each FPS system needs its own temperature cache to prevent interference
# - Each FPS wrapper (_TX1, _TX2, etc) makes it easy to define all your tool macros
# - The LANE parameter uses lane0-lane3 (or however many lanes you have) per FPS
# - The actual tool numbers (T0-T3, T4-T7, T8-T11) are defined in the individual tool macros
# - All core logic is in SAFE_UNLOAD_FILAMENT and _TX, so expansions are simple wrappers
