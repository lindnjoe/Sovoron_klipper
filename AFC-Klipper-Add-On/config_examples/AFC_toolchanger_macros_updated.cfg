# AFC + Toolchanger Bridge Macros
#
# This file provides macros for AFC with klipper-toolchanger-easy integration.
# Follows the same pattern as AFC_oams_macros.cfg with base macros and specific wrappers.
#
# STRUCTURE:
# - SAFE_UNLOAD_FILAMENT: Base unload macro (takes parameters)
# - SAFE_UNLOAD_FILAMENT0/1/4/5: Specific wrappers for each tool
# - _TX: Base load macro (takes parameters)
# - _TX0/_TX1/_TX4/_TX5: Specific wrappers for each tool
#
# FEATURES:
# - Automatic tool change detection via AFC_toolchanger_bridge
# - Automatic docking for OpenAMS units (dock_when_swap_extruders)
# - Tool cutting support (tool_cut)
# - Smart temperature management (compatible with _oams_smart_temp_settings)
# - Per-tool configuration via simple wrappers


# ═══════════════════════════════════════════════════════════════════════════
# BASE UNLOAD MACRO
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro SAFE_UNLOAD_FILAMENT]
variable_pause_triggered: False
variable_retry: 0

gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set TOOL_NUM = params.TOOL|default("0")|string %}
    {% set LANE = params.LANE|default("")|string %}
    {% set CACHE = params.CACHE|default("_toolchanger_temp_cache")|string %}
    {% set LED_NAME = params.LED|default("AFC_indicator")|string %}

    {% set UNLOAD_SPEED = 1000 %}
    {% set ADDITIONAL_UNLOAD_SPEED = 5000 %}
    {% set ADDITIONAL_TIME_ON = 2.0 %}
    {% set ADDITIONAL_EXTRUSION_AMOUNT = ADDITIONAL_UNLOAD_SPEED / 60.0 * (ADDITIONAL_TIME_ON + 1.0) %}

    # Read values from AFC_extruder config
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set extrusion_unload_length = afc_extruder.tool_stn %}

    # Get current temperature
    {% set current_target_temp = printer.extruder.target|int %}
    {% set temp = current_target_temp %}

    # Check if smart temperature is enabled
    {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
        # Smart temp enabled: Get temperature from loaded lane
        {% set extruder_obj = 'AFC_extruder ' ~ EXTRUDER %}
        {% if extruder_obj in printer and 'lane_loaded' in printer[extruder_obj] %}
            {% set loaded_lane = printer[extruder_obj]['lane_loaded']|default('', true)|string %}
            {% if loaded_lane %}
                {% set lane_obj = "AFC_lane " ~ loaded_lane %}
                {% if lane_obj in printer and 'extruder_temp' in printer[lane_obj] %}
                    {% set temp = printer[lane_obj]['extruder_temp']|int %}
                    RESPOND MSG="[Toolchanger] Using lane temp: {temp}C for {loaded_lane}"
                {% endif %}
            {% endif %}
        {% endif %}

        # Heat to the temp
        M104 S{temp}
        M117 Nozzle heating to {temp}C...
        {action_respond_info("Nozzle heating to %dC..." % temp)}
        {% if temp < 210 %}
            M109 S210
        {% else %}
            M109 S{temp}
        {% endif %}
    {% else %}
        # Smart temp disabled or not available - use current temp
        {% if printer.print_stats.state not in ["printing", "paused"] and temp < 210 %}
            {% set temp = 240 %}
            M104 S{temp}
            M117 Heating to default {temp}C...
            {action_respond_info("Heating to default %dC..." % temp)}
            M109 S{temp}
        {% else %}
            M117 Unloading at current temp {temp}C...
        {% endif %}
    {% endif %}

    # Cache the temp for use during load
    {% if CACHE in printer %}
        SET_GCODE_VARIABLE MACRO={CACHE} VARIABLE=old_temp VALUE={temp}
    {% endif %}

    # Standard AFC unload sequence
    SET_STEPPER_ENABLE STEPPER={EXTRUDER} ENABLE=1
    M83
    G92 E0
    G1 E-{retract_length}

    # Cut if enabled (handled by bridge in prepare_lane, but manual unload needs this)
    {% if printer.AFC.tool_cut %}
        AFC_CUT
        M400
    {% endif %}

    SET_GCODE_OFFSET X=0 Y=0 Z=0
    M83
    G92 E0
    G1 E-90 F{UNLOAD_SPEED}
    M400
    G1 E-{ADDITIONAL_EXTRUSION_AMOUNT} F{ADDITIONAL_UNLOAD_SPEED}
    G4 P1000

    # Call AFC's built-in unload if LANE provided
    {% if LANE %}
        TOOL_UNLOAD LANE={LANE}
    {% endif %}

    M400

    {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
        M104 S0
        M400
    {% endif %}

    {% if LED_NAME %}
        SET_LED LED={LED_NAME} INDEX=1 RED=1 GREEN=0 BLUE=0
    {% endif %}


# ═══════════════════════════════════════════════════════════════════════════
# SPECIFIC UNLOAD WRAPPERS (Update per tool)
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro SAFE_UNLOAD_FILAMENT0]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder TOOL=0 CACHE=_toolchanger_temp_cache_t0 LED=AFC_indicator {rawparams}

[gcode_macro SAFE_UNLOAD_FILAMENT1]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder1 TOOL=1 CACHE=_toolchanger_temp_cache_t1 LED=AFC_indicator {rawparams}

[gcode_macro SAFE_UNLOAD_FILAMENT4]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder4 TOOL=4 CACHE=_toolchanger_temp_cache_t4 LED=AFC_Sndicator {rawparams}

[gcode_macro SAFE_UNLOAD_FILAMENT5]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder5 TOOL=5 CACHE=_toolchanger_temp_cache_t5 LED=AFC_Tndicator {rawparams}


# ═══════════════════════════════════════════════════════════════════════════
# BASE LOAD MACRO (_TX)
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _TX]
variable_pause_triggered: False

gcode:
    {% set GROUP = params.GROUP %}
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set TOOL_NUM = params.TOOL|default("0")|string %}
    {% set LANE = params.LANE|default("")|string %}
    {% set CACHE = params.CACHE|default("_toolchanger_temp_cache")|string %}
    {% set LED_NAME = params.LED|default("AFC_indicator")|string %}

    # Parse GROUP to extract lane number if LANE not provided
    # GROUP format: T0, T1, T4, etc.
    {% if LANE == "" %}
        {% set lane_num = GROUP.replace('T', '') if 'T' in GROUP else GROUP %}
        {% set LANE = "lane" ~ lane_num %}
    {% endif %}

    # Read values from AFC_extruder config
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set hotend_meltzone_compensation = printer["gcode_macro _oams_macro_variables"].hotend_meltzone_compensation if 'gcode_macro _oams_macro_variables' in printer else 0 %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set extrusion_reload_length = afc_extruder.tool_stn_unload %}
    {% set reload_speed = (afc_extruder.tool_load_speed * 10 * 60)|int %}
    {% set RELOAD_LENGTH = (extrusion_reload_length + retract_length + hotend_meltzone_compensation) %}

    {% set current_target_temp = printer.extruder.target|int %}

    {% if printer.toolhead.homed_axes != 'xyz' %}
        RESPOND TYPE=command MSG='Homing'
        G28
    {% endif %}

    RESPOND TYPE=command MSG='Loading {GROUP} (Lane: {LANE}) on {EXTRUDER}'

    # Calculate temperature
    {% set purge_temp = current_target_temp %}

    # Check if smart temperature is enabled
    {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
        # Smart temp enabled: Calculate optimal purge temperature
        {% set old_temp = printer["gcode_macro " ~ CACHE].old_temp|default(240)|int if CACHE in printer else 240 %}

        # Get new lane temp
        {% set new_temp = 240 %}
        {% set lane_obj = "AFC_lane " ~ LANE %}
        {% if lane_obj in printer and 'extruder_temp' in printer[lane_obj] %}
            {% set new_temp = printer[lane_obj]['extruder_temp']|int %}
        {% endif %}

        # Calculate max temperature for purge
        {% set purge_temp = old_temp if old_temp > new_temp else new_temp %}
        RESPOND MSG="[Toolchanger] Calculated purge temp: {purge_temp}C (max of {old_temp}C and {new_temp}C)"
    {% else %}
        # Smart temp disabled
        {% if printer.print_stats.state not in ["printing", "paused"] and purge_temp < 210 %}
            {% set purge_temp = 240 %}
        {% endif %}
        RESPOND MSG="[Toolchanger] Using temp: {purge_temp}C"
    {% endif %}

    # ═══════════════════════════════════════════════════════════════════════
    # BRIDGE INTEGRATION: Prepare lane change
    # ═══════════════════════════════════════════════════════════════════════
    # This handles:
    # - Tool docking (if dock_when_swap enabled for this extruder)
    # - Tool changing (if different extruder)
    # - Tool cutting (if tool_cut=True)

    AFC_BRIDGE_PREPARE_LANE LANE={LANE}

    # ═══════════════════════════════════════════════════════════════════════
    # Temperature and Loading
    # ═══════════════════════════════════════════════════════════════════════

    # Heat to purge temp
    {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
        M104 S{purge_temp}
        M117 Heating to {purge_temp}C for {GROUP}...
        {action_respond_info("Heating to %dC for %s..." % (purge_temp, GROUP))}
        {% if purge_temp < 210 %}
            M109 S210
        {% else %}
            M109 S{purge_temp}
        {% endif %}
    {% else %}
        # Smart temp disabled
        {% if printer.print_stats.state not in ["printing", "paused"] and purge_temp < 210 %}
            M104 S{purge_temp}
            M117 Heating to {purge_temp}C for {GROUP}...
            M109 S{purge_temp}
        {% else %}
            M117 Loading {GROUP} at current temp {purge_temp}C...
        {% endif %}
    {% endif %}

    # Load the new spool using AFC
    TOOL_LOAD LANE={LANE}
    M400
    G4 P500

    # ═══════════════════════════════════════════════════════════════════════
    # BRIDGE INTEGRATION: Finalize lane change
    # ═══════════════════════════════════════════════════════════════════════
    # This handles:
    # - Tool pickup (if we docked it earlier)
    # - Purge (if auto_purge=True and purge_before_pickup configured)
    # - Tool verification (if verify_tool_mounted=True)

    AFC_BRIDGE_LANE_LOADED LANE={LANE}

    {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
        M104 S0
        M400
    {% endif %}

    # Set LED
    {% if LED_NAME %}
        SET_LED LED={LED_NAME} INDEX=1 RED=0 GREEN=1 BLUE=0
    {% endif %}


# ═══════════════════════════════════════════════════════════════════════════
# SPECIFIC LOAD WRAPPERS (Update per tool)
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _TX0]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder TOOL=0 CACHE=_toolchanger_temp_cache_t0 LED=AFC_indicator

[gcode_macro _TX1]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder1 TOOL=1 CACHE=_toolchanger_temp_cache_t1 LED=AFC_indicator

[gcode_macro _TX4]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder4 TOOL=4 CACHE=_toolchanger_temp_cache_t4 LED=AFC_Sndicator

[gcode_macro _TX5]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder5 TOOL=5 CACHE=_toolchanger_temp_cache_t5 LED=AFC_Tndicator


# ═══════════════════════════════════════════════════════════════════════════
# TEMPERATURE CACHE MACROS
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _toolchanger_temp_cache_t0]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed

[gcode_macro _toolchanger_temp_cache_t1]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed

[gcode_macro _toolchanger_temp_cache_t4]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed

[gcode_macro _toolchanger_temp_cache_t5]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed


# ═══════════════════════════════════════════════════════════════════════════
# DIAGNOSTIC COMMANDS
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro CHECK_BRIDGE_STATUS]
description: Show AFC toolchanger bridge status and mappings
gcode:
    AFC_BRIDGE_STATUS

[gcode_macro CHECK_LANE_TOOL]
description: Check which tool a lane uses
gcode:
    {% set LANE = params.LANE|default("lane0")|string %}
    AFC_BRIDGE_GET_TOOL LANE={LANE}


# ═══════════════════════════════════════════════════════════════════════════
# EXAMPLE: Adding More Tools
# ═══════════════════════════════════════════════════════════════════════════
#
# To add additional tools, follow this pattern:
#
# 1. Create a temperature cache macro:
#    [gcode_macro _toolchanger_temp_cache_t2]
#    variable_target_temp: 240
#    variable_old_temp: 240
#    gcode:
#
# 2. Create wrapper macros:
#    [gcode_macro SAFE_UNLOAD_FILAMENT2]
#    gcode:
#        SAFE_UNLOAD_FILAMENT EXTRUDER=extruder2 TOOL=2 CACHE=_toolchanger_temp_cache_t2 LED=AFC_indicator {rawparams}
#
#    [gcode_macro _TX2]
#    gcode:
#        {% set GROUP = params.GROUP %}
#        _TX GROUP={GROUP} EXTRUDER=extruder2 TOOL=2 CACHE=_toolchanger_temp_cache_t2 LED=AFC_indicator
#
# Parameters explanation:
# - EXTRUDER: The Klipper extruder name (extruder, extruder1, extruder4, etc)
# - TOOL: The tool number for SELECT_TOOL command (0, 1, 4, 5, etc)
# - CACHE: The temperature cache macro name for this tool
# - LED: The LED indicator name for this tool (optional)
# - LANE: Auto-calculated from GROUP (T4 → lane4) or can be passed explicitly


# ═══════════════════════════════════════════════════════════════════════════
# MIGRATION FROM CUSTOM MACROS
# ═══════════════════════════════════════════════════════════════════════════
#
# If you previously had custom_load_cmd and custom_unload_cmd in your lane configs:
#
# BEFORE:
# [AFC_lane lane4]
# unit: AMS_1:1
# extruder: extruder4
# map: T4
# custom_load_cmd: _TX1 GROUP=T4
# custom_unload_cmd: SAFE_UNLOAD_FILAMENT1
#
# AFTER (Option 1 - Keep using macros):
# [AFC_lane lane4]
# unit: AMS_1:1
# extruder: extruder4
# map: T4
# custom_load_cmd: _TX4 GROUP=T4
# custom_unload_cmd: SAFE_UNLOAD_FILAMENT4
#
# AFTER (Option 2 - Use AFC_CHANGE_LANE directly):
# [AFC_lane lane4]
# unit: AMS_1:1
# extruder: extruder4
# map: T4
# # No custom commands needed - use AFC_CHANGE_LANE instead!
#
# Then in your slicer:
# AFC_CHANGE_LANE FROM={previous_filament} TO={next_filament}


# ═══════════════════════════════════════════════════════════════════════════
# TESTING CHECKLIST
# ═══════════════════════════════════════════════════════════════════════════
#
# 1. Verify Bridge Initialization
#    Run: AFC_BRIDGE_STATUS
#    Check: All lanes are mapped to correct tools
#
# 2. Test Same-Tool Lane Swap (e.g., lane4→lane6, both on extruder4)
#    Run: _TX4 GROUP=T6
#    Expected with dock_when_swap_extruders containing extruder4:
#      - Tool docks before load
#      - Filament loads
#      - Bridge calls purge (if auto_purge=True)
#      - Tool picks up
#    Expected without extruder4 in dock_when_swap_extruders:
#      - No tool change
#      - Direct lane swap
#
# 3. Test Different-Tool Change (e.g., lane4→lane0, extruder4→extruder)
#    Run: _TX0 GROUP=T0
#    Expected:
#      - SELECT_TOOL automatically called
#      - Tool offsets applied
#      - Detection verified (if enabled)
#
# 4. Test Tool Detection
#    Reboot with tool mounted
#    Check klippy.log: "Toolchanger: Detected tool at startup: T4"
#    Run: AFC_BRIDGE_STATUS
#    Verify: Active and Detected tool match
