[gcode_macro PRINT_START]
gcode:
  {% set TOOL_TEMP = params.TOOL_TEMP|default(147)|float %}
  {% set BED_TEMP = params.BED_TEMP|default(0)|float %}
  INITIALIZE_TOOLCHANGER
  STOP_CRASH_DETECTION
  #M104 S150
  M190 S{ BED_TEMP }
  G28
 # M109 S150
  G0 F30000
  
  M104 T{params.TOOL} S147
 
  G32
  SELECT_TOOL T=0
  AFC_BRUSH  
  CARTOGRAPHER_TOUCH_HOME


   M400
   BED_MESH_CALIBRATE ADAPTIVE=1
   T{params.TOOL}
   M400

   M109 T{params.TOOL} S{TOOL_TEMP}
   M400  
  _TOOLCHANGER_PRINT_START_END

[gcode_macro AMS_STOP]
gcode:
  OAMSM_FOLLOWER ENABLE=0 DIRECTION=1 FPS=fps1
  OAMSM_FOLLOWER ENABLE=0 DIRECTION=1 FPS=fps2

# [gcode_macro M104]
# rename_existing: M104.1
# description: [T<index>] [S<temperature>]
#   Set tool temperature.
#   T= Tool number, optional. If this parameter is not provided, the current tool is used.
#   S= Target temperature
# gcode:
#   {% if params.T is defined %}
#     {% set newparameters = "" %}
#     {% set newparameters = newparameters ~ " T="~params.T %}
#     {% if params.S is defined %}
#       {% set newparameters = newparameters ~ " TARGET="~params.S %}
#     {% endif %}
#     SET_TOOL_TEMPERATURE{newparameters}
#   {% else %}
#     M104.1 {rawparams}
#   {% endif %}

# [gcode_macro M109]
# rename_existing: M109.9999
# description: [T<index>] [S<temperature>] [D<Deadband>]
#   Set tool temperature and wait with deadband option.
#   T= Tool number [optional]. If this parameter is not provided, the current tool is used.
#   S= Target temperature
#   D= Dead-band, allows the temperature variance +/- the deadband
# gcode:
#   {% if params.T is defined %}
#     {% set newparameters = " T="~params.T %}
#   {% endif %}

#   {% if params.S is defined %}
#     {% set newparameters = newparameters~" S="~params.S %}
#   {% endif %}

#   {% if params.D is defined %}
#     {% set newparameters = newparameters~" D="~params.D %}
#   {% endif %}

#   SET_TEMPERATURE_WITH_DEADBAND {newparameters}


# [gcode_macro SET_TEMPERATURE_WITH_DEADBAND]
# description: [T<index>] [S<temperature>] [D<Deadband>]
#   Set tool temperature and wait.
#   T= Tool number [optional]. If this parameter is not provided, the current tool is used.
#   S= Target temperature
#   D= Dead-band, allows the temperature variance +/- the deadband
# variable_default_deadband: 10.0
# gcode:
#     {% set s = params.S|default(0)|int %}
#     {% set tn = params.T|default(printer.toolchanger.tool_number)|int %}
#     {% set d = params.D|default(default_deadband)|float %}
    
#     {% set tool = printer.toolchanger.tool_names[tn]|default('') %}
#     {% set extruder = printer[tool].extruder %}

#     SET_HEATER_TEMPERATURE HEATER={extruder} TARGET={s}
#     {% if s > 0 %}
#         RESPOND type=echo MSG='{"Waiting For Extruder with Deadband: "~d}'
#         TEMPERATURE_WAIT SENSOR={extruder} MINIMUM={s-(d/2)} MAXIMUM={s+(d/2)}   ; Wait for hotend temp (within D degrees)
#     {% endif %}
 
# [gcode_macro PRINT_START]
# gcode:
#     {% set TOOL = params.TOOL | default(-1)| int %}
#     {% set TOOL_TEMP = params.TOOL_TEMP | default(0) | int %}
#     {% set BED_TEMP = params.BED_TEMP | default(0) | int %}

#     STOP_CRASH_DETECTION
    
#     M117 Heating Bed
#     M190 S{BED_TEMP}
    
#     M117 Homing
#     G28
#     SELECT_TOOL T=0

#     M117 Quad Gantry Level
#     G32
#     # QUAD_GANTRY_LEVEL
#     # G28 Z
#     # {% if TOOL >= 0 %}
#     #     M104 T0 S0 ; shutdown T0.  If it's up first it will be heated below.
#     #     T{params.TOOL}
#     #     {% set initialToolTemp = 'T' ~ params.TOOL|string ~ '_TEMP' %}
#     #     M117 Waiting on T{params.TOOL} S{params[initialToolTemp]}C
#     #     M109 S{params[initialToolTemp]}
#     # {% else %}
#         M109 S{TOOL_TEMP}
#     # {% endif %}

  
    

#   # {% for tool_nr in printer.toolchanger.tool_numbers %}
#   #     {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
#   #     {% if tooltemp_param in params %}
#   #       M104 T{tool_nr} S{params[tooltemp_param]}
#   #     {% endif %}
#   #   {% endfor %}

#   #    M117 Heating up the hotend
#   # G90 ; Absolute positioning
#   # G92 E0 ; Zero extruder
#   # M106 S100 ; Start part cooling fan, 255=100%
#   # G0 Z10 F3000
#   # _MOVE_TO_CENTER
#   # M109 S{ TOOL_TEMP }
   
#     LOAD_BED_MESH_PROFILE
#     START_CRASH_DETECTION
    


[gcode_macro LOAD_BED_MESH_PROFILE]
gcode:
    {% if printer['heater_bed'].temperature <= 70 %}
        BED_MESH_PROFILE LOAD=default  ; Load the default bed mesh profile if the bed temperature is 60째C or below
         M117 Bed Mesh default loaded
    {% elif printer['heater_bed'].temperature >= 99 %}
        BED_MESH_PROFILE LOAD=ABS      ; Load the ABS-specific bed mesh profile if the bed temperature is 100째C or higher
         M117 Bed Mesh ABS loaded
    {% else %}
        BED_MESH_PROFILE LOAD=hightemp ; Load the high-temp bed mesh profile if the bed temperature is between 61째C and 99째C
         M117 Bed Mesh hightemp loaded
    {% endif %}

[gcode_macro CLEAN_NOZZLE]
gcode:
    _TOOLCHANGER_CLEAN_NOZZLE

# [gcode_macro TOOLCHANGE_DEMO]
# description: [SAMPLES=<int>]
#   Run random tool changes.
#   SAMPLES= Number of changes to run, default is 20.
# gcode:
#     {% set t = params.SAMPLES|default(20)|int %}
#     {% for n in range(t) %}
#       T{ printer.toolchanger.tool_numbers | random }
#     {% endfor %}

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    QUAD_GANTRY_LEVEL
    G28 Z

[gcode_macro PRINT_STATUS]
gcode:
  {% set obj = params.OBJ %}
  RESPOND TYPE=echo MSG="Status for M190 {obj} is { printer[obj] }"

[gcode_macro UNSAFE_LOWER_TOOLHEAD]
description: Lower the bed 100mm without homing
gcode:
  G90
  SET_KINEMATIC_POSITION Z=100
  G0 Z0 F6000
  M84

[gcode_macro UNSAFE_RAISE_TOOLHEAD]
description: Raise the bed 100mm without homing
gcode:
  G90
  SET_KINEMATIC_POSITION Z=0
  G0 Z100 F6000
  M84

[gcode_macro LOAD_FILAMENT]
gcode:
  M117 Loading
  M104 S240
  G90 ; Absolute pos
  G1 X280 Y00 Z35 F1800 ; Move to center
  M104 S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83                            ; set extruder to relative
  G1 E50 F300                   ; extrude 5 cm
  G1 E50 F300                   ; extrude 5 cm
  G1 E-4 F1800                  ; retract some
  M82                           ; set extruder to absolute
  M400                          ; wait for buffer to clear
  M104 S0                       ; Stop heating
  M117 Loading done

[gcode_macro UNLOAD_FILAMENT]
gcode:
  M117 Unloading
  M104 S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83                           ; set extruder to relative
  G1 E5 F500                   ; extrude 5 mm
  G1 E-50 F1000                   ; retract 5 cm
  G1 E-50 F1000                   ; retract 5 cm
  M82                            ; set extruder to absolute
  M400                          ; wait for buffer to clear
  TURN_OFF_HEATERS
  M117 Unloading done

[gcode_macro LOAD_ONE_FILAMENT]
gcode:
  M117 Loading {params.TOOL}
  M109 T{params.TOOL} S240 ;Wait until heated
  {% set start_extruder = printer.toolhead.extruder %}
  {% set tool_name = printer.toolchanger.tool_names[params.TOOL|int] %}
  {% set extruder = printer[tool_name].extruder %}
  M104 T{params.TOOL} S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={extruder} MINIMUM=240
  ACTIVATE_EXTRUDER EXTRUDER={extruder}
  M83                           ; set extruder to relative
  G1 E50 F300                   ; extrude 5 mm
  G1 E50 F300                   ; extrude 5 cm
  G1 E-4 F1800                   ; retract 4 cm
  M82                            ; set extruder to absolute
  M400                          ; wait for buffer to clear
  M104 S0
  ACTIVATE_EXTRUDER EXTRUDER={start_extruder}
  M117 Loading done

[gcode_macro UNLOAD_ONE_FILAMENT]
gcode:
  M117 Unloading {params.TOOL}
  M109 T{params.TOOL} S240 ;Wait until heated
  {% set start_extruder = printer.toolhead.extruder %}
  {% set tool_name = printer.toolchanger.tool_names[params.TOOL|int] %}
  {% set extruder = printer[tool_name].extruder %}
  M104 T{params.TOOL} S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={extruder} MINIMUM=240
  ACTIVATE_EXTRUDER EXTRUDER={extruder}
  M83                           ; set extruder to relative
  G1 E5 F500                   ; extrude 5 mm
  G1 E-50 F1000                   ; retract 5 cm
  G1 E-50 F1000                   ; retract 5 cm
  M82                            ; set extruder to absolute
  M400                          ; wait for buffer to clear
  TURN_OFF_HEATERS
  ACTIVATE_EXTRUDER EXTRUDER={start_extruder}
  M117 Unloading done

[gcode_macro UNLOAD_ALL_FILAMENT]
gcode:
  {% set start_extruder = printer.toolhead.extruder %}
  {% set tools = printer.toolchanger.tool_names %}
  M117 Unloading
  {% for tool in tools %}
    M104 T{printer[tool].tool_number} S240 ;Heat up the filament
  {% endfor %}
  {% for tool in tools %}
    M109 T{printer[tool].tool_number} S240 ;Wait until heated
    ACTIVATE_EXTRUDER EXTRUDER={printer[tool].extruder}
    M83                           ; set extruder to relative
    G1 E5 F500                     ; extrude 5 mm
    G1 E-50 F1000                   ; retract 5 cm
    G1 E-50 F1000                   ; retract 5 cm
  {% endfor %}
  M400                          ; Finish all th emoves
  M82                            ; set extruder to absolute
  TURN_OFF_HEATERS
  ACTIVATE_EXTRUDER EXTRUDER={start_extruder}
  M117 Unloading done

[gcode_macro CHANGE_NOZZLE]
gcode:
  M117 Nozzle change
  M104 S240
  G90 ; Absolute pos
  G1 X175 Y0 Z100 F1800 ; Move to front
  M109 S240 ;Heat up the filament
  M83                            ; set extruder to relative
  G1 E5 F250                   ; extrude 5 mm
  G1 E-50 F1000                ; retract 5 cm
  M82                            ; set extruder to absolute
  M117 Ready to swap


# [gcode_macro M109]
# rename_existing: M109.9999
# description: [T<index>] [S<temperature>] [D<Deadband>]
#   Set tool temperature and wait.
#   T= Tool number [optional]. If this parameter is not provided, the current tool is used.
#   S= Target temperature
#   D= Dead-band, allows the temperature variance +/- the deadband
# variable_default_deadband: 20.0
# gcode:
#     {% set s = params.S|float %}
#     {% set deadband = default_deadband|float %}
#     {% if params.D is defined %}
#         {% set deadband = params.D|float %}
#     {% endif %}
#     {% set tn = params.T|default(printer.tool_probe_endstop.active_tool_number)|int %}
#     {% set tool = printer.toolchanger.tool_names[tn]|default('') %}
#     {% set extruder = printer[tool].extruder %}

#     SET_HEATER_TEMPERATURE HEATER={extruder} TARGET={s}
#     {% if s > 0 %}
#         TEMPERATURE_WAIT SENSOR={extruder} MINIMUM={s-(deadband/2)} MAXIMUM={s+(deadband/2)}   ; Wait for hotend temp (within D degrees)
#     {% endif %}