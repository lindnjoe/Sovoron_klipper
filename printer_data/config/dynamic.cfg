[gcode_macro HEAT_SOAK_BED]
description: "Heat soak the bed at 65C for 5 minutes"
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(65)|float %}
  {% set SOAK_TIME = params.SOAK_TIME|default(300)|int %}
  M140 S{BED_TEMP}                     ; Set bed temperature (no wait)
  M190 S{BED_TEMP}                     ; Wait for bed to reach target
  RESPOND TYPE=command MSG="action:prompt_begin Heat soaking bed for {SOAK_TIME // 60}m"
  RESPOND TYPE=command MSG="action:prompt_button Skip SKIP_HEAT_SOAK"
  RESPOND TYPE=command MSG="action:prompt_end"
  PAUSE
  UPDATE_DELAYED_GCODE ID=END_HEAT_SOAK DURATION={SOAK_TIME}

[delayed_gcode END_HEAT_SOAK]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  RESUME
  RESPOND MSG="Heat soak complete"

[gcode_macro SKIP_HEAT_SOAK]
gcode:
  UPDATE_DELAYED_GCODE ID=END_HEAT_SOAK DURATION=0
  {% if printer.print_stats.state != 'printing' %}
    M140 S0
  {% endif %}
  RESUME
  RESPOND MSG="Heat soak skipped"

[gcode_macro WAIT_HEAT_SOAK]
variable_threshold_temp: 45 # in Â°C
gcode:
  {% set threshold = threshold_temp|float %}
  {% if printer.heater_bed.temperature < threshold %}
    HEAT_SOAK_BED
  {% else %}
    RESPOND MSG="skipping heat soak... ({printer.heater_bed.temperature} > {threshold}) "
  {% endif %}