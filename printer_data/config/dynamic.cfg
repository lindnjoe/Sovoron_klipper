[gcode_macro HEAT_SOAK_BED]
description: "Heat soak the bed at 65C for 5 minutes"
variable_soak_active: 0
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(65)|float %}
  {% set SOAK_TIME = params.SOAK_TIME|default(300)|int %}
  SET_GCODE_VARIABLE MACRO=HEAT_SOAK_BED VARIABLE=soak_active VALUE=1
  M140 S{BED_TEMP}                     ; Set bed temperature (no wait)
  M190 S{BED_TEMP}                     ; Wait for bed to reach target
  RESPOND TYPE=command MSG="action:prompt_begin Heat soaking bed for {SOAK_TIME // 60}m"
  RESPOND TYPE=command MSG="action:prompt_button Skip SKIP_HEAT_SOAK"
  RESPOND TYPE=command MSG="action:prompt_show"
  UPDATE_DELAYED_GCODE ID=END_HEAT_SOAK DURATION={SOAK_TIME}
  PAUSE

[delayed_gcode END_HEAT_SOAK]
initial_duration: 1
gcode:
  UPDATE_DELAYED_GCODE ID=END_HEAT_SOAK DURATION=0
  {% if printer["gcode_macro HEAT_SOAK_BED"].soak_active|int %}
    RESPOND TYPE=command MSG="action:prompt_end"
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK_BED VARIABLE=soak_active VALUE=0
    RESUME
    RESPOND MSG="Heat soak complete"
  {% endif %}

[gcode_macro SKIP_HEAT_SOAK]
gcode:
  RESPOND TYPE=command MSG="action:prompt_end"
  UPDATE_DELAYED_GCODE ID=END_HEAT_SOAK DURATION=0
  {% if printer.print_stats.state != 'printing' %}
    M140 S0
  {% endif %}
  SET_GCODE_VARIABLE MACRO=HEAT_SOAK_BED VARIABLE=soak_active VALUE=0
  RESUME
  RESPOND MSG="Heat soak skipped"

[gcode_macro WAIT_HEAT_SOAK]
variable_threshold_temp: 35 # in Â°C
gcode:
  {% set threshold = threshold_temp|float %}
  {% if printer.heater_bed.temperature < threshold %}
    HEAT_SOAK_BED
  {% else %}
    RESPOND MSG="skipping heat soak... ({printer.heater_bed.temperature} > {threshold}) "
  {% endif %}

