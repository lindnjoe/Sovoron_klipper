#####################################################################
# AFC M109 Deadband Override Module
#####################################################################
# This module provides a toggleable override for AFC's M109 macro
# to automatically use the deadband configured for each AFC extruder
#
# Usage:
#   AFC_M109_DEADBAND_ENABLE  - Enable automatic deadband usage
#   AFC_M109_DEADBAND_DISABLE - Disable automatic deadband usage
#   AFC_M109_DEADBAND_STATUS  - Show current status
#
# When enabled, M109 commands will automatically use the deadband
# value configured in AFC_Hardware.cfg for each extruder.
#####################################################################

[gcode_macro _AFC_M109_DEADBAND_OVERRIDE]
description: Variables for AFC M109 deadband override control
variable_enabled: 1  # Default: enabled (1=on, 0=off)
gcode:
    # This macro just stores variables

[gcode_macro AFC_M109_DEADBAND_ENABLE]
description: Enable automatic AFC deadband usage in M109
gcode:
    SET_GCODE_VARIABLE MACRO=_AFC_M109_DEADBAND_OVERRIDE VARIABLE=enabled VALUE=1
    RESPOND MSG="AFC M109 Deadband Override: ENABLED - M109 will use AFC extruder deadband settings"

[gcode_macro AFC_M109_DEADBAND_DISABLE]
description: Disable automatic AFC deadband usage in M109
gcode:
    SET_GCODE_VARIABLE MACRO=_AFC_M109_DEADBAND_OVERRIDE VARIABLE=enabled VALUE=0
    RESPOND MSG="AFC M109 Deadband Override: DISABLED - M109 will use default AFC behavior"

[gcode_macro AFC_M109_DEADBAND_STATUS]
description: Show status of AFC M109 deadband override
gcode:
    {% set override = printer['gcode_macro _AFC_M109_DEADBAND_OVERRIDE'] %}
    {% if override.enabled %}
        RESPOND MSG="AFC M109 Deadband Override: ENABLED"
    {% else %}
        RESPOND MSG="AFC M109 Deadband Override: DISABLED"
    {% endif %}

#####################################################################
# M109 Override Macro
#####################################################################
# This macro intercepts M109 and adds the deadband parameter
# automatically based on the AFC extruder configuration

[gcode_macro M109]
rename_existing: M109.AFC_BASE
description: Override M109 to use AFC extruder deadband settings
gcode:
    {% set override = printer['gcode_macro _AFC_M109_DEADBAND_OVERRIDE'] %}
    {% set temp = params.S|default(0)|float %}
    {% set tool_num = params.T|default(None) %}

    # Build the base command parameters
    {% set cmd = "AFC_M109" %}
    {% if temp > 0 %}
        {% set cmd = cmd ~ " S=" ~ temp %}
    {% endif %}
    {% if tool_num is not none %}
        {% set cmd = cmd ~ " T=" ~ tool_num %}
    {% endif %}

    # If override is enabled, add the deadband parameter
    {% if override.enabled %}
        # Get the deadband from AFC extruder configuration
        {% set deadband = None %}

        # Determine which extruder to use
        {% if tool_num is not none %}
            # Tool number specified, look up the extruder
            {% set extruder_name = "extruder" if tool_num|int == 0 else "extruder" ~ tool_num %}
        {% else %}
            # No tool specified, use current extruder
            {% set extruder_name = printer.toolhead.extruder %}
        {% endif %}

        # Try to get deadband from AFC extruder config
        {% if "AFC_extruder " ~ extruder_name in printer %}
            {% set afc_extruder = printer["AFC_extruder " ~ extruder_name] %}
            {% if afc_extruder.deadband is defined %}
                {% set deadband = afc_extruder.deadband %}
            {% endif %}
        {% endif %}

        # Add deadband parameter if found
        {% if deadband is not none %}
            {% set cmd = cmd ~ " D=" ~ deadband %}
            RESPOND PREFIX="M109" MSG="Using AFC extruder deadband: {deadband}Â°C for {extruder_name}"
        {% else %}
            RESPOND PREFIX="M109" MSG="No AFC deadband found for {extruder_name}, using default behavior"
        {% endif %}
    {% endif %}

    # Execute the AFC M109 command
    {cmd}