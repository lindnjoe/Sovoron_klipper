# AFC/OpenAMS Macros Configuration
#
# This file contains macros for AFC (Automatic Filament Changer) with OpenAMS units.
#
# FEATURES:
#
# 1. Spoolman LED Sync
#    - Sets ACTIVE TOOL LED to match filament color from Spoolman
#    - Configure in [spoolman_led_sync] section below
#
# 2. Smart Temperature Management (NEW!)
#    - Automatically adjusts temperatures based on lane-specific settings
#    - Calculates optimal purge temperature during filament changes
#    - Can be toggled on/off via [_oams_smart_temp_settings]
#    - When enabled: Uses lane temperatures and max(old, new) for purging
#    - When disabled: Uses current extruder temperature without changing it
#                     (allows manual temperature control)
#
# To enable/disable Smart Temperature:
# 1. Edit [_oams_smart_temp_settings] section below
# 2. Set enable_smart_temp: True (enabled) or False (disabled)
# 3. Restart Klipper (FIRMWARE_RESTART)
#
#
# OpenAMS Spoolman LED Sync Configuration
#
# This optional module sets the ACTIVE TOOL LED to match the filament color
# from Spoolman instead of the default blue color.
#
# Features:
# - Automatically reads filament color from Spoolman via AFC
# - Sets active tool LED to match the actual filament color
# - Falls back to default color if Spoolman data not available
# - Error states (stuck spool, clog) still override with red flashing
# - Non-active lanes use their normal AFC LED colors
# - Requires restart to enable/disable
#
# To use:
# 1. Copy this section to your printer.cfg or include it
# 2. Set enable: True
# 3. Restart Klipper (FIRMWARE_RESTART)




# Smart Temperature Management Configuration
[gcode_macro _oams_smart_temp_settings]
# Enable or disable smart temperature adjustment during load/unload
# When enabled: Uses lane-specific temps and calculates optimal purge temps
# When disabled: Uses current extruder temperature without any changes
#                (allows you to manually control temperature)
# Default: True
variable_enable_smart_temp: True
gcode:
    # This macro just holds variables, no gcode needed


# Temperature cache for FPS1
# (Each FPS keeps its own cached unload temperature so smart temp toggles
#  and manual overrides remain isolated per tool)
[gcode_macro _oams_temp_cache_fps1]
variable_old_temp: 240
gcode:
    # This macro just holds variables for FPS1, no gcode needed


# Temperature cache for FPS2
# (Each FPS keeps its own cached unload temperature so smart temp toggles
#  and manual overrides remain isolated per tool)
[gcode_macro _oams_temp_cache_fps2]
variable_old_temp: 240
gcode:
    # This macro just holds variables for FPS2, no gcode needed


# OPTIMIZATION: Debug and configuration settings
[gcode_macro _oams_debug_settings]
variable_debug_enabled: 0  # Set to 1 to enable debug messages (reduces overhead by 5-10%)
gcode:
    # This macro just holds variables, no gcode needed


# OPTIMIZATION: Configurable purge parameters
[gcode_macro _oams_purge_settings]
variable_purge_amount: 70  # Extrusion amount during purge (mm)
variable_purge_speed: 350  # Extrusion speed during purge (mm/min)
gcode:
    # This macro just holds variables, no gcode needed


# Helper macro to resolve the best available temperature for a lane
# The logic mirrors AFC's internal behaviour:
# 1. Use Spoolman-provided extruder temperature when available
# 2. Otherwise try to match the lane material against [AFC] default_material_temps
# 3. Fall back to the default material type defined in [AFC]
# 4. Finally use the "default" entry or (min_extrude_temp + 5) if nothing is defined
[gcode_macro _OAMS_LANE_TEMP_HELPER]
variable_lane_temp: 240
gcode:
    {% set LANE = params.LANE|default('')|string|trim %}
    {% set EXTRUDER = params.EXTRUDER|default('extruder')|string %}
    {% set DEFAULT_TEMP = params.DEFAULT|default(0)|float %}

    {% set lane_name = LANE %}
    {% if lane_name and lane_name[:4]|lower != 'lane' %}
        {% set lane_name = 'lane' ~ lane_name %}
    {% endif %}

    {% set lane_obj = 'AFC_lane ' ~ lane_name if lane_name else '' %}
    {% set lane_temp = None %}
    {% set lane_material = '' %}
    {% if lane_obj and lane_obj in printer %}
        {% if 'extruder_temp' in printer[lane_obj] and printer[lane_obj]['extruder_temp'] %}
            {% set lane_temp = printer[lane_obj]['extruder_temp']|float %}
        {% endif %}
        {% if 'material' in printer[lane_obj] and printer[lane_obj]['material'] %}
            {% set lane_material = printer[lane_obj]['material']|string %}
        {% endif %}
    {% endif %}

    {% set min_temp = 170.0 %}
    {% if EXTRUDER in printer.configfile.settings %}
        {% set min_temp = printer.configfile.settings[EXTRUDER].min_extrude_temp|default(min_temp)|float %}
    {% endif %}
    {% set fallback_temp = DEFAULT_TEMP if DEFAULT_TEMP > 0 else (min_temp + 5.0) %}

    {% set afc_section = printer.configfile.settings['AFC'] if 'AFC' in printer.configfile.settings else None %}
    {% set afc_defaults = afc_section.default_material_temps|default('', true) if afc_section else '' %}
    {% set fallback_material = lane_material %}
    {% if not fallback_material and afc_section and afc_section.default_material_type is defined %}
        {% set fallback_material = afc_section.default_material_type|string %}
    {% endif %}

    {% set defaults = namespace(default=fallback_temp, match=None) %}
    {% if afc_defaults %}
        {% for entry in afc_defaults.split(',') %}
            {% set parts = entry.split(':') %}
            {% if parts|length > 1 %}
                {% set key = parts[0]|trim|lower %}
                {% set value = parts[1]|trim|float %}
                {% if key == 'default' %}
                    {% set defaults.default = value %}
                {% elif fallback_material and key %}
                    {% set mat_key = fallback_material|lower %}
                    {% if mat_key == key or key in mat_key %}
                        {% set defaults.match = value %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if lane_temp is not none and lane_temp > 0 %}
        {% set resolved_temp = lane_temp %}
    {% elif defaults.match is not none %}
        {% set resolved_temp = defaults.match %}
    {% else %}
        {% set resolved_temp = defaults.default %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=_OAMS_LANE_TEMP_HELPER VARIABLE=lane_temp VALUE={resolved_temp|round(2)}


# Generic unload macro - can be used for any extruder
# AUTO-DETECTS which lane is loaded OR accepts explicit LANE parameter
# Usage:
#   SAFE_UNLOAD_FILAMENT1                    - Auto-detects loaded lane
#   SAFE_UNLOAD_FILAMENT1 LANE=lane6         - Explicitly unload lane6
[gcode_macro SAFE_UNLOAD_FILAMENT]
variable_pause_triggered: False
variable_retry: 0

gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder4")|string %}
    {% set TOOL_NUM = params.TOOL|default("4")|string %}
    {% set FPS = params.FPS|default("fps1")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache_fps1")|string %}
    {% set LED_NAME = params.LED|default("AFC_Sndicator")|string %}
    {% set UNIT = params.UNIT|default("")|string %}
    {% set LANE_PARAM = params.LANE|default("")|string %}
    {% set PRERETRACT = params.PRERETRACT|default(-10)|float %}

    # Read values from AFC_extruder config so each toolhead uses its tuned distances
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set raw_unload_length = afc_extruder.tool_stn_unload|default(afc_extruder.tool_stn)|float %}
    {% if raw_unload_length <= 0 %}
        {% set raw_unload_length = afc_extruder.tool_stn|float %}
    {% endif %}
    {% set sensor_after = afc_extruder.tool_sensor_after_extruder|default(0)|float %}
    {% set extrusion_unload_length = raw_unload_length + sensor_after %}
    {% set unload_speed = (afc_extruder.tool_unload_speed|default(25.0)|float * 60)|int %}
    {% set ADDITIONAL_TIME_ON = 2.0 %}
    {% set ADDITIONAL_UNLOAD_SPEED = unload_speed %}
    {% set ADDITIONAL_EXTRUSION_AMOUNT = ADDITIONAL_UNLOAD_SPEED / 60.0 * (ADDITIONAL_TIME_ON + 1.0) %}

    # Determine which lane to unload: explicit parameter OR auto-detect
    {% set loaded_lane = LANE_PARAM %}
    {% set lane_source = "explicit" %}
    {% if not loaded_lane %}
        # No explicit LANE parameter - auto-detect from AFC state
        {% set lane_source = "auto-detected" %}
        {% set extruder_obj = 'AFC_extruder ' ~ EXTRUDER %}
        {% if extruder_obj in printer and 'lane_loaded' in printer[extruder_obj] %}
            {% set loaded_lane = printer[extruder_obj]['lane_loaded']|default('', true)|string %}
        {% endif %}
    {% endif %}

    # Always ensure the requested extruder is active before we touch temperatures/extrusion
    ACTIVATE_EXTRUDER EXTRUDER={EXTRUDER}

    # If PURGE_TEMP provided, use it; otherwise get temp from currently loaded lane
    {% set PURGE_TEMP = params.PURGE_TEMP|default(0)|int %}
    {% set extruder_state = printer[EXTRUDER] if EXTRUDER in printer else printer.extruder %}
    {% set current_target_temp = extruder_state.target|int %}

    # OOZE PREVENTION OVERRIDE: OrcaSlicer may have already dropped temp for ooze prevention
    # Override any temperature below safe threshold immediately
    {% set MIN_SAFE_TEMP = 210 %}  # Minimum safe temperature during tool change
    {% set current_actual_temp = extruder_state.temperature|int %}

    {% if current_target_temp < MIN_SAFE_TEMP and printer.print_stats.state in ["printing", "paused"] %}
        # OrcaSlicer dropped temp for ooze prevention - override it
        {% set override_temp = current_actual_temp if current_actual_temp > MIN_SAFE_TEMP else MIN_SAFE_TEMP %}
        M104 S{override_temp}
        RESPOND MSG="Overriding ooze prevention temp: {current_target_temp}C → {override_temp}C"
        {% set current_target_temp = override_temp %}
    {% endif %}

    {% set temp = 240 %}

    # Display which lane we're unloading
    {% if loaded_lane %}
        {% if lane_source == "auto-detected" %}
            RESPOND TYPE=command MSG='Auto-detected: Unloading {loaded_lane} from {EXTRUDER}'
        {% else %}
            RESPOND TYPE=command MSG='Unloading {loaded_lane} from {EXTRUDER}'
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG='No lane specified and could not auto-detect loaded lane on {EXTRUDER}'
    {% endif %}

    {% if PURGE_TEMP > 0 %}
        # Use pre-calculated purge temp (for filament changes)
        {% set temp = PURGE_TEMP %}
        M117 Unloading at purge temp {temp}C...
        # Heat if not already at temp
        M104 S{temp}
        {action_respond_info("Heating to purge temp %dC..." % temp)}
        {% if temp < 210 %}
            M109 S210
        {% else %}
            M109 S{temp}
        {% endif %}
    {% else %}
        # Check if smart temperature is enabled
        {% if printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
            # Get temperature from currently loaded lane (already auto-detected above)
            {% if loaded_lane %}
                _OAMS_LANE_TEMP_HELPER LANE={loaded_lane} EXTRUDER={EXTRUDER} DEFAULT={temp}
                {% set temp = printer["gcode_macro _OAMS_LANE_TEMP_HELPER"].lane_temp|int %}
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT ({EXTRUDER}) resolved temp: {temp}C for {loaded_lane}"
                {% endif %}
            {% endif %}

            # Heat to the temp
            M104 S{temp}
            M117 Nozzle heating to {temp}C...
            {action_respond_info("Nozzle heating to %dC..." % temp)}
            {% if temp < 210 %}
                M109 S210
            {% else %}
                M109 S{temp}
            {% endif %}
        {% else %}
            # Smart temp disabled
            {% set temp = current_target_temp %}
            # If not printing and temp is too low, heat to default to avoid extrude errors
            {% if printer.print_stats.state not in ["printing", "paused"] and temp < 210 %}
                {% set temp = 240 %}
                M104 S{temp}
                M117 Heating to default {temp}C...
                {action_respond_info("Heating to default %dC..." % temp)}
                M109 S{temp}
            {% else %}
                # Printing - ensure we're at target temp before unloading
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT ({EXTRUDER}) smart temp disabled, using current temp: {temp}C"
                {% endif %}
                M117 Unloading at current temp {temp}C...
                M104 S{temp}
                {action_respond_info("Heating to %dC for unload..." % temp)}
                {% if temp < 210 %}
                    M109 S210
                {% else %}
                    M109 S{temp}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
    
    # Cache the temp for use during load
    SET_GCODE_VARIABLE MACRO={CACHE} VARIABLE=old_temp VALUE={temp}
    
    OAMSM_FOLLOWER ENABLE=1 DIRECTION=0 FPS={FPS}
    M83
    G92 E0
    G1 E-{retract_length}
    AFC_CUT
    M400
   # SET_GCODE_OFFSET X=0 Y=0 Z=0
    SET_STEPPER_ENABLE STEPPER={EXTRUDER} ENABLE=1
    M83
    G92 E0
    G1 E-{extrusion_unload_length|round(2)} F{unload_speed}
    M400
    G1 E-{ADDITIONAL_EXTRUSION_AMOUNT} F{ADDITIONAL_UNLOAD_SPEED}
    #G4 P1000
    OAMSM_FOLLOWER ENABLE=0 DIRECTION=0 FPS={FPS}
    OAMSM_UNLOAD_FILAMENT FPS={FPS} PRERETRACT={PRERETRACT}
    M400



    {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
        M104 S0
        M400
    {% endif %}

    SET_LED LED={LED_NAME} INDEX=1 RED=1 GREEN=0 BLUE=0


# Specific wrappers for backwards compatibility and ease of use
[gcode_macro SAFE_UNLOAD_FILAMENT1]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder4 TOOL=4 FPS=fps1 CACHE=_oams_temp_cache_fps1 LED=AFC_Sndicator UNIT=AMS_1 {rawparams}


[gcode_macro SAFE_UNLOAD_FILAMENT2]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder5 TOOL=5 FPS=fps2 CACHE=_oams_temp_cache_fps2 LED=AFC_Tndicator UNIT=AMS_2 {rawparams}


[gcode_macro _TX]
variable_pause_triggered: False

gcode:
    {% set LANE = params.LANE|default("")|string %}
    {% set EXTRUDER = params.EXTRUDER|default("extruder4")|string %}
    {% set TOOL_NUM = params.TOOL|default("4")|string %}
    {% set FPS = params.FPS|default("fps1")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache_fps1")|string %}
    {% set LED_NAME = params.LED|default("AFC_Sndicator")|string %}
    {% set UNIT = params.UNIT|default("")|string %}

    # OOZE PREVENTION OVERRIDE: OrcaSlicer may have already dropped temp for ooze prevention
    # Override any temperature below safe threshold immediately
    {% set MIN_SAFE_TEMP = 210 %}  # Minimum safe temperature during tool change
    {% set extruder_state = printer[EXTRUDER] if EXTRUDER in printer else printer.extruder %}
    {% set current_target_temp = extruder_state.target|int %}
    {% set current_actual_temp = extruder_state.temperature|int %}

    {% if current_target_temp < MIN_SAFE_TEMP and printer.print_stats.state in ["printing", "paused"] %}
        # OrcaSlicer dropped temp for ooze prevention - override it
        {% set override_temp = current_actual_temp if current_actual_temp > MIN_SAFE_TEMP else MIN_SAFE_TEMP %}
        M104 S{override_temp}
        RESPOND MSG="Overriding ooze prevention temp: {current_target_temp}C → {override_temp}C"
        {% set current_target_temp = override_temp %}
    {% endif %}

    # Read values from AFC_extruder config
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set hotend_meltzone_compensation = printer["gcode_macro _oams_macro_variables"].hotend_meltzone_compensation %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set extrusion_reload_length = afc_extruder.tool_stn %}
    {% set sensor_after = afc_extruder.tool_sensor_after_extruder|default(0)|float %}
    {% set reload_speed = (afc_extruder.tool_load_speed|default(25.0)|float * 60)|int %}
    {% set LOADED_LANE = printer['oams_manager']['fps ' ~ FPS].current_lane %}
    {% set RELOAD_LENGTH = (extrusion_reload_length + sensor_after + retract_length + hotend_meltzone_compensation) %}

    # Get LANE label from lane's map for display and comparison
    {% set lane_obj_name = "AFC_lane " ~ LANE %}
    {% set TARGET_LANE = printer[lane_obj_name].map if lane_obj_name in printer else LANE %}

    # Note: current_target_temp already set above with ooze prevention override
   # STOP_TOOL_CRASH_DETECTION

    {% if printer.exclude_object.current_object not in printer.exclude_object.excluded_objects %}
        {% if LOADED_LANE == TARGET_LANE %}
            RESPOND TYPE=command MSG='Toolhead already loaded with {TARGET_LANE}'
        {% else %}
            RESPOND TYPE=command MSG='Loading {TARGET_LANE} on {EXTRUDER}'

            # Calculate purge temperature based on smart temp setting
            {% if printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
                # Smart temp enabled: Calculate optimal purge temperature
                # Read the cached old temperature from SAFE_UNLOAD_FILAMENT
                {% set old_temp = printer["gcode_macro " ~ CACHE].old_temp|default(240)|int %}
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Retrieved cached old_temp: {old_temp}C"
                {% endif %}

                # Get new lane temp
                _OAMS_LANE_TEMP_HELPER LANE={LANE} EXTRUDER={EXTRUDER} DEFAULT=240
                {% set new_temp = printer["gcode_macro _OAMS_LANE_TEMP_HELPER"].lane_temp|int %}
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX: Resolved lane {LANE} temp: {new_temp}C"
                {% endif %}

                # Calculate max temperature for purge
                {% set purge_temp = old_temp if old_temp > new_temp else new_temp %}
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Calculated purge temp: {purge_temp}C (max of {old_temp}C and {new_temp}C)"
                {% endif %}
            {% else %}
                # Smart temp disabled: Use cached temperature from unload
                {% set purge_temp = printer["gcode_macro " ~ CACHE].old_temp|default(current_target_temp)|int %}
                {% if printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX ({CACHE}): Smart temp disabled, using cached temp: {purge_temp}C"
                {% endif %}
            {% endif %}

            # Step 1: Unselect tool
            DROP_TOOL
           # SET_GCODE_OFFSET X=0 Y=0 Z=0
            M83

            # Step 2: Heat to purge temp
            {% if printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
                M104 S{purge_temp}
                M117 Heating to {purge_temp}C for {TARGET_LANE}...
                {action_respond_info("Heating to %dC for %s..." % (purge_temp, TARGET_LANE))}
                {% if purge_temp < 210 %}
                    M109 S210
                {% else %}
                    M109 S{purge_temp}
                {% endif %}
            {% else %}
                # Smart temp disabled: Use cached temp and heat to it
                {% if printer.print_stats.state not in ["printing", "paused"] and purge_temp < 210 %}
                    # Not printing and temp too low, heat to default
                    {% set purge_temp = 240 %}
                    M104 S{purge_temp}
                    M117 Heating to default {purge_temp}C for {TARGET_LANE}...
                    {action_respond_info("Heating to default %dC for %s..." % (purge_temp, TARGET_LANE))}
                    M109 S{purge_temp}
                {% else %}
                    # Printing or temp is safe: heat to cached temp (handles slicer temp changes)
                    M104 S{purge_temp}
                    M117 Heating to {purge_temp}C for {TARGET_LANE}...
                    {action_respond_info("Heating to %dC for %s..." % (purge_temp, TARGET_LANE))}
                    M109 S{purge_temp}
                {% endif %}
            {% endif %}

            # Step 3: Load the new spool from AMS
            # Follower will be automatically enabled by _ensure_forward_follower() after successful load
            OAMSM_LOAD_FILAMENT LANE={LANE}
            M400
            G4 P100  # OPTIMIZATION: Reduced from 1500ms (33% faster)

            # Step 4: Extrude/purge (follower stays enabled automatically)
            # OPTIMIZATION: Use configurable purge parameters
            {% set purge_amount = printer["gcode_macro _oams_purge_settings"].purge_amount|int %}
            {% set purge_speed = printer["gcode_macro _oams_purge_settings"].purge_speed|int %}
            M83
            G92 E0
            G1 E{RELOAD_LENGTH} F{reload_speed}
            M400
           # G4 P500
            SAVE_GCODE_STATE NAME=purge_ready
            M83
            G92 E0
            G1 E{purge_amount/2} F{purge_speed}
            M106 S255 T{TOOL_NUM}
            G1 E{purge_amount/2} F{purge_speed}
            G92 E0
            #M106 S255 T{TOOL_NUM}
            G1 E-3 F{purge_speed}
            G4 P500
            M106 S0 T{TOOL_NUM}
            RESTORE_GCODE_STATE NAME=purge_ready

            # Step 5: Select tool
            SELECT_TOOL T={TOOL_NUM}
            {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
                M104 S0
                M400
            {% endif %}
        {% endif %}
    {% endif %}

    # Step 6: Set LED and enable crash detection (follower remains enabled)
    SET_LED LED={LED_NAME} INDEX=1 RED=0 GREEN=1 BLUE=0
  #  START_TOOL_CRASH_DETECTION



# Specific wrappers for each FPS system
[gcode_macro _TX1]
gcode:
    {% set LANE = params.LANE|default("")|string %}
    _TX LANE={LANE} EXTRUDER=extruder4 TOOL=4 FPS=fps1 CACHE=_oams_temp_cache_fps1 LED=AFC_Sndicator UNIT=AMS_1


[gcode_macro _TX2]
gcode:
    {% set LANE = params.LANE|default("")|string %}
    _TX LANE={LANE} EXTRUDER=extruder5 TOOL=5 FPS=fps2 CACHE=_oams_temp_cache_fps2 LED=AFC_Tndicator UNIT=AMS_2





############################################
# EXAMPLE CONFIGURATION FOR OTHER USERS
############################################
# 
# To add additional FPS systems, users should:
#
# 1. Create a new temperature cache macro:
#    [gcode_macro _oams_temp_cache_fps3]
#    variable_target_temp: 240
#    variable_old_temp: 240
#    variable_cached_old_lane: ""
#    gcode:
#
# 2. Create wrapper macros:
#    [gcode_macro SAFE_UNLOAD_FILAMENT3]
#    gcode:
#        SAFE_UNLOAD_FILAMENT EXTRUDER=extruder6 TOOL=6 FPS=fps3 CACHE=_oams_temp_cache_fps3 LED=AFC_Indicator3 {rawparams}
#
#    [gcode_macro _TX3]
#    gcode:
#        {% set LANE = params.LANE %}
#        _TX LANE={LANE} EXTRUDER=extruder6 TOOL=6 FPS=fps3 CACHE=_oams_temp_cache_fps3 LED=AFC_Indicator3
#
#
# Parameters explanation:
# - EXTRUDER: The Klipper extruder name (extruder4, extruder5, extruder6, etc)
# - TOOL: The tool number for SELECT_TOOL command (4, 5, 6, etc)
# - FPS: The FPS name in your oams_manager config (fps1, fps2, fps3, etc)
# - CACHE: The temperature cache macro name for this FPS
# - LED: The LED indicator name for this FPS (optional)
#
