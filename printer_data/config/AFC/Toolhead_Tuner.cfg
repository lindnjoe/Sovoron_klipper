[gcode_macro Toolhead_Tuner]
description: Popup UI for manual extruder tuning
gcode:
  {% set active_extruder = printer.toolhead.extruder|default("extruder") %}
  {% set active_extruder_num = 0 if active_extruder == "extruder" else active_extruder|replace("extruder", "")|int %}
  {% set afc_extruder = printer["AFC_extruder " ~ active_extruder] if ("AFC_extruder " ~ active_extruder) in printer else {} %}
  {% set extrude_default = afc_extruder.tool_stn|default(1.0)|float %}
  {% set retract_default = afc_extruder.tool_stn_unload|default(extrude_default)|float %}
  RESPOND TYPE=command MSG="action:prompt_begin Toolhead Tuner"
  RESPOND TYPE=command MSG="action:prompt_text Choose extruder and distances (mm)"
  RESPOND TYPE=command MSG="action:prompt_text Extruder"
  RESPOND TYPE=command MSG="action:prompt_input extruder|{active_extruder_num}"
  RESPOND TYPE=command MSG="action:prompt_text Extrude mm"
  RESPOND TYPE=command MSG="action:prompt_input extrude_len|{extrude_default}"
  RESPOND TYPE=command MSG="action:prompt_text Retract mm"
  RESPOND TYPE=command MSG="action:prompt_input retract_len|{retract_default}"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button -1 |TOOLHEAD_TUNER_MOVE EXTRUDER={extruder} DIST=-1|secondary"
  RESPOND TYPE=command MSG="action:prompt_button RETRACT |TOOLHEAD_TUNER_MOVE EXTRUDER={extruder} DIST=-{retract_len}|primary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button EXTRUDE |TOOLHEAD_TUNER_MOVE EXTRUDER={extruder} DIST={extrude_len}|primary"
  RESPOND TYPE=command MSG="action:prompt_button +1 |TOOLHEAD_TUNER_MOVE EXTRUDER={extruder} DIST=1|secondary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_footer_button Update Toolhead Values|TOOLHEAD_TUNER_SAVE EXTRUDER={extruder} EXTRUDE_LEN={extrude_len} RETRACT_LEN={retract_len}|success"
  RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=\"action:prompt_end\"|error"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro TOOLHEAD_TUNER_MOVE]
description: Move the active extruder by a requested amount
gcode:
  {% set extruder_num = params.EXTRUDER|default(0)|int %}
  {% set extruder_name = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  {% if extruder_name not in printer %}
    RESPOND TYPE=error MSG="Toolhead_Tuner: extruder {extruder_num} not found"
  {% else %}
    {% set dist = params.DIST|default(0)|float %}
    {% if dist == 0 %}
      RESPOND TYPE=error MSG="Toolhead_Tuner: distance is 0"
    {% else %}
      ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
      {% set extruder_state = printer[extruder_name] %}
      SAVE_GCODE_STATE NAME=TOOLHEAD_TUNER_STATE
      M83
      {% if not extruder_state.can_extrude %}
        M104 T{extruder_num} S210
        M109 T{extruder_num} S210
      {% endif %}
      G1 E{dist} F300
      RESTORE_GCODE_STATE NAME=TOOLHEAD_TUNER_STATE
    {% endif %}
  {% endif %}

[gcode_macro TOOLHEAD_TUNER_SAVE]
description: Save toolhead tuning values back to AFC config
gcode:
  {% set extruder_num = params.EXTRUDER|default(0)|int %}
  {% set extruder_name = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  {% if extruder_name not in printer %}
    RESPOND TYPE=error MSG="Toolhead_Tuner: extruder {extruder_num} not found"
  {% else %}
    {% set extrude_len = params.EXTRUDE_LEN|default(0)|float %}
    {% set retract_len = params.RETRACT_LEN|default(0)|float %}
    UPDATE_TOOLHEAD_SENSORS EXTRUDER={extruder_name} TOOL_STN={extrude_len} TOOL_STN_UNLOAD={retract_len}
    SAVE_EXTRUDER_VALUES EXTRUDER={extruder_name}
  {% endif %}