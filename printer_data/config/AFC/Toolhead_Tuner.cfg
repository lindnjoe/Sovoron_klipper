[gcode_macro Toolhead_Tuner]
description: Popup UI for manual extruder tuning
variable_extruder: -1
variable_extrude_len: 0.0
variable_retract_len: 0.0
variable_extrude_temp: 240.0
gcode:
  {% set active_extruder = printer.toolhead.extruder|default("extruder") %}
  {% set active_extruder_num = 0 if active_extruder == "extruder" else active_extruder|replace("extruder", "")|int %}
  {% set tuner = printer["gcode_macro Toolhead_Tuner"] %}
  {% set extruder_num = tuner.extruder|int %}
  {% set extrude_len = tuner.extrude_len|float %}
  {% set retract_len = tuner.retract_len|float %}
  {% if extruder_num < 0 %}
    {% set extruder_num = active_extruder_num %}
  {% endif %}
  {% set selected_extruder = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  {% set afc_extruder = printer["AFC_extruder " ~ selected_extruder] if ("AFC_extruder " ~ selected_extruder) in printer else {} %}
  {% set extrude_default = afc_extruder.tool_stn|default(1.0)|float %}
  {% set retract_default = afc_extruder.tool_stn_unload|default(extrude_default)|float %}
  {% if extrude_len <= 0 %}
    {% set extrude_len = extrude_default %}
  {% endif %}
  {% if retract_len <= 0 %}
    {% set retract_len = retract_default %}
  {% endif %}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=extruder VALUE={extruder_num}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=extrude_len VALUE={extrude_len}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=retract_len VALUE={retract_len}
  RESPOND TYPE=command MSG="action:prompt_begin Toolhead Tuner"
  RESPOND TYPE=command MSG="action:prompt_text Choose extruder and distances (mm)"
  RESPOND TYPE=command MSG="action:prompt_text Extruder buttons switch to the selected tool."
  RESPOND TYPE=command MSG="action:prompt_text Test Settings buttons heat to 240C if needed, then move using the values."
  {% set extruder_label = "Extruder" if extruder_num == 0 else ("Extruder " ~ extruder_num) %}
  RESPOND TYPE=command MSG="action:prompt_text {extruder_label}"
  {% set extruder_sections = namespace(items=[]) %}
  {% for name in printer.configfile.settings %}
    {% if name.startswith("extruder") %}
      {% set extruder_sections.items = extruder_sections.items + [name] %}
    {% endif %}
  {% endfor %}
  {% set extruder_sections_sorted = extruder_sections.items|sort %}
  {% if extruder_sections_sorted|length > 0 %}
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    {% for name in extruder_sections_sorted %}
      {% set name_num = 0 if name == "extruder" else name|replace("extruder", "")|int %}
      {% set button_label = "Extruder" if name_num == 0 else ("Extruder " ~ name_num) %}
      {% if name_num == extruder_num %}
        RESPOND TYPE=command MSG="action:prompt_button {button_label}|_TOOLHEAD_TUNER_SELECT EXTRUDER={name_num}|primary"
      {% else %}
        RESPOND TYPE=command MSG="action:prompt_button {button_label}|_TOOLHEAD_TUNER_SELECT EXTRUDER={name_num}|secondary"
      {% endif %}
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
  {% endif %}
  RESPOND TYPE=command MSG="action:prompt_text Extrude (tool_stn): {extrude_len}"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button -5|_TOOLHEAD_TUNER_SET EXTRUDE_LEN={extrude_len - 5}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button -1|_TOOLHEAD_TUNER_SET EXTRUDE_LEN={extrude_len - 1}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button +1|_TOOLHEAD_TUNER_SET EXTRUDE_LEN={extrude_len + 1}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button +5|_TOOLHEAD_TUNER_SET EXTRUDE_LEN={extrude_len + 5}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_text Retract (tool_stn_unload): {retract_len}"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button -5|_TOOLHEAD_TUNER_SET RETRACT_LEN={retract_len - 5}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button -1|_TOOLHEAD_TUNER_SET RETRACT_LEN={retract_len - 1}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button +1|_TOOLHEAD_TUNER_SET RETRACT_LEN={retract_len + 1}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button +5|_TOOLHEAD_TUNER_SET RETRACT_LEN={retract_len + 5}|secondary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_text Test Settings:"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button EXTRUDE |_TOOLHEAD_TUNER_MOVE EXTRUDER={extruder_num} DIST={extrude_len}|primary"
  RESPOND TYPE=command MSG="action:prompt_button +1 |_TOOLHEAD_TUNER_MOVE EXTRUDER={extruder_num} DIST=1|secondary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_button_group_start"
  RESPOND TYPE=command MSG="action:prompt_button RETRACT |_TOOLHEAD_TUNER_MOVE EXTRUDER={extruder_num} DIST=-{retract_len}|primary"
  RESPOND TYPE=command MSG="action:prompt_button -1 |_TOOLHEAD_TUNER_MOVE EXTRUDER={extruder_num} DIST=-1|secondary"
  RESPOND TYPE=command MSG="action:prompt_button_group_end"
  RESPOND TYPE=command MSG="action:prompt_footer_button Update Toolhead Values|_TOOLHEAD_TUNER_SAVE EXTRUDER={extruder_num} EXTRUDE_LEN={extrude_len} RETRACT_LEN={retract_len}|success"
  RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=\"action:prompt_end\"|error"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _TOOLHEAD_TUNER_SET]
description: Update Toolhead_Tuner values and refresh the prompt
gcode:
  {% set tuner = printer["gcode_macro Toolhead_Tuner"] %}
  {% set extruder_num = params.EXTRUDER|default(tuner.extruder)|int %}
  {% set extrude_len = params.EXTRUDE_LEN|default(tuner.extrude_len)|float %}
  {% set retract_len = params.RETRACT_LEN|default(tuner.retract_len)|float %}
  {% if extruder_num < 0 %}
    {% set extruder_num = 0 %}
  {% endif %}
  {% if params.EXTRUDER is defined and params.EXTRUDE_LEN is not defined and params.RETRACT_LEN is not defined %}
    {% set selected_extruder = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
    {% set afc_extruder = printer["AFC_extruder " ~ selected_extruder] if ("AFC_extruder " ~ selected_extruder) in printer else {} %}
    {% set extrude_len = afc_extruder.tool_stn|default(1.0)|float %}
    {% set retract_len = afc_extruder.tool_stn_unload|default(extrude_len)|float %}
    {% if selected_extruder in printer %}
      ACTIVATE_EXTRUDER EXTRUDER={selected_extruder}
    {% endif %}
  {% endif %}
  {% if extrude_len <= 0 %}
    {% set extrude_len = 0.1 %}
  {% endif %}
  {% if retract_len <= 0 %}
    {% set retract_len = 0.1 %}
  {% endif %}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=extruder VALUE={extruder_num}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=extrude_len VALUE={extrude_len}
  SET_GCODE_VARIABLE MACRO=Toolhead_Tuner VARIABLE=retract_len VALUE={retract_len}
  Toolhead_Tuner

[gcode_macro _TOOLHEAD_TUNER_SELECT]
description: Select an extruder with AFC and refresh the tuner prompt
gcode:
  {% set extruder_num = params.EXTRUDER|default(0)|int %}
  {% set extruder_name = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  AFC_SELECT_TOOL TOOL={extruder_name}
  _TOOLHEAD_TUNER_SET EXTRUDER={extruder_num}

[gcode_macro _TOOLHEAD_TUNER_MOVE]
description: Move the active extruder by a requested amount
gcode:
  {% set extruder_num = params.EXTRUDER|default(0)|int %}
  {% set extruder_name = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  {% if extruder_name not in printer %}
    RESPOND TYPE=error MSG="Toolhead_Tuner: extruder {extruder_num} not found"
  {% else %}
    {% set dist = params.DIST|default(0)|float %}
    {% if dist == 0 %}
      RESPOND TYPE=error MSG="Toolhead_Tuner: distance is 0"
    {% else %}
      {% set tuner = printer["gcode_macro Toolhead_Tuner"] %}
      {% set extrude_temp = tuner.extrude_temp|default(240)|float %}
      ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
      {% set extruder_state = printer[extruder_name] %}
      SAVE_GCODE_STATE NAME=TOOLHEAD_TUNER_STATE
      M83
      {% set min_extrude_temp = extruder_state.min_extrude_temp|default(0)|float %}
      {% if extruder_state.temperature < min_extrude_temp %}
        M104 T{extruder_num} S{extrude_temp}
        M109 T{extruder_num} S{extrude_temp}
      {% endif %}
      G1 E{dist} F300
      RESTORE_GCODE_STATE NAME=TOOLHEAD_TUNER_STATE
    {% endif %}
  {% endif %}

[gcode_macro _TOOLHEAD_TUNER_SAVE]
description: Save toolhead tuning values back to AFC config
gcode:
  {% set extruder_num = params.EXTRUDER|default(0)|int %}
  {% set extruder_name = "extruder" if extruder_num == 0 else "extruder" ~ extruder_num %}
  {% if extruder_name not in printer %}
    RESPOND TYPE=error MSG="Toolhead_Tuner: extruder {extruder_num} not found"
  {% else %}
    {% set extrude_len = params.EXTRUDE_LEN|default(0)|float %}
    {% set retract_len = params.RETRACT_LEN|default(0)|float %}
    UPDATE_TOOLHEAD_SENSORS EXTRUDER={extruder_name} TOOL_STN={extrude_len} TOOL_STN_UNLOAD={retract_len}
    SAVE_EXTRUDER_VALUES EXTRUDER={extruder_name}
  {% endif %}
