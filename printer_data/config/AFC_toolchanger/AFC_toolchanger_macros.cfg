# AFC + Toolchanger Bridge Macros (Updated)
#
# This file shows how to integrate AFC_toolchanger_bridge into your existing macros
# using the helper command approach (Option A).
#
# CHANGES FROM ORIGINAL:
# - Removed manual tool selection logic
# - Added AFC_BRIDGE_PREPARE_LANE before load
# - Added AFC_BRIDGE_LANE_LOADED after load
# - Bridge now handles all tool docking/undocking/changing
#
# BENEFITS:
# - Automatic tool change detection (only changes when extruder differs)
# - Automatic docking for same-tool swaps (if dock_when_swap=True)
# - Tool verification via detection pins
# - Cleaner, simpler macros

# -------------------------------------------------------------------------------
# HELPER MACRO - Updated for Bridge Integration
# -------------------------------------------------------------------------------

[gcode_macro _TX1]
gcode:
    {% set GROUP = params.GROUP|default("T0")|string %}
    {% set LANE = params.LANE|default("")|string %}

    # Extract lane number from GROUP if LANE not provided
    # GROUP format is usually "T4", "T6", etc.
    {% if LANE == "" %}
        {% set lane_num = GROUP[1:] %}  # Remove 'T' prefix
        {% set LANE = "lane" ~ lane_num %}
    {% endif %}

    RESPOND MSG="[AFC Bridge] Loading {LANE} (Group: {GROUP})"

    # -------------------------------------------------------------------------
    # STEP 1: Bridge Preparation
    # -------------------------------------------------------------------------
    # This handles:
    # - Tool docking (if dock_when_swap=True and same extruder)
    # - Tool changing (if different extruder)
    # - Tool verification (if verify_tool_mounted=True)

    AFC_BRIDGE_PREPARE_LANE LANE={LANE}

    # -------------------------------------------------------------------------
    # STEP 2: Temperature Management (Your Existing Logic)
    # -------------------------------------------------------------------------

    {% if printer['gcode_macro _oams_smart_temp_settings'].enable_smart_temp %}
        # Smart temperature is enabled
        {% set cache_macro = printer['gcode_macro _oams_temp_cache_fps1'] %}
        {% set target_temp = cache_macro.target_temp|default(240)|int %}
        {% set extruder_name = "extruder4" %}  # Update per instance (_TX1, _TX2, etc.)

        RESPOND MSG="[AFC Bridge] Setting {extruder_name} to {target_temp}C"
        M109 S{target_temp}
    {% else %}
        # Smart temp disabled, use current temperature
        RESPOND MSG="[AFC Bridge] Smart temp disabled, using current temperature"
    {% endif %}

    # -------------------------------------------------------------------------
    # STEP 3: Filament Loading (Your Existing Logic)
    # -------------------------------------------------------------------------

    RESPOND MSG="[AFC Bridge] Loading filament into toolhead"
    LOAD_NOZZLE

    # -------------------------------------------------------------------------
    # STEP 4: Bridge Finalization
    # -------------------------------------------------------------------------
    # This handles:
    # - Tool pickup (if we docked it earlier)
    # - Tool verification (if verify_tool_mounted=True)
    # - Auto purge (if auto_purge=True)

    AFC_BRIDGE_LANE_LOADED LANE={LANE}

    RESPOND MSG="[AFC Bridge] {LANE} loaded and ready"


# ---------------------------------------------------------------------------
# INSTANCE-SPECIFIC MACROS (Update per FPS/AMS unit)
# ---------------------------------------------------------------------------

# FPS1 / AMS_1 Instance
[gcode_macro SAFE_UNLOAD_FILAMENT1]
gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder4")|string %}
    {% set TOOL_NUM = params.TOOL|default("4")|string %}
    {% set FPS = params.FPS|default("fps1")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache_fps1")|string %}
    {% set LED_NAME = params.LED|default("AFC_Sndicator")|string %}
    {% set UNIT = params.UNIT|default("AMS_1")|string %}

    RESPOND MSG="[AFC Bridge] Unloading from {EXTRUDER} (Tool {TOOL_NUM})"

    # Your existing unload logic
    # Temperature caching, OpenAMS unload sequence, etc.

    # Note: Bridge doesn't need to be involved in unload
    # Tool stays mounted during unload (unless dock_when_swap triggers on next load)


# FPS2 / AMS_2 Instance
[gcode_macro SAFE_UNLOAD_FILAMENT2]
gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder5")|string %}
    {% set TOOL_NUM = params.TOOL|default("5")|string %}
    {% set FPS = params.FPS|default("fps2")|string %}
    {% set CACHE = params.CACHE|default("_oams_temp_cache_fps2")|string %}
    {% set LED_NAME = params.LED|default("AFC_Tndicator")|string %}
    {% set UNIT = params.UNIT|default("AMS_2")|string %}

    RESPOND MSG="[AFC Bridge] Unloading from {EXTRUDER} (Tool {TOOL_NUM})"

    # Your existing unload logic


# ---------------------------------------------------------------------------
# EXAMPLE: Simplified Future Version (Optional)
# ---------------------------------------------------------------------------
# Once you're comfortable with the bridge, you could simplify to:

# [gcode_macro TOOL_CHANGE]
# gcode:
#     {% set TO_LANE = params.TO_LANE|default("")|string %}
#     {% set FROM_LANE = params.FROM_LANE|default("")|string %}
#
#     # Bridge handles everything: tool change, dock, load, pickup, purge
#     AFC_CHANGE_LANE FROM={FROM_LANE} TO={TO_LANE}


# ---------------------------------------------------------------------------
# DIAGNOSTIC COMMANDS
# ---------------------------------------------------------------------------

[gcode_macro CHECK_BRIDGE_STATUS]
description: Show AFC toolchanger bridge status and mappings
gcode:
    AFC_BRIDGE_STATUS

[gcode_macro CHECK_LANE_TOOL]
description: Check which tool a lane uses
gcode:
    {% set LANE = params.LANE|default("lane4")|string %}
    AFC_BRIDGE_GET_TOOL LANE={LANE}


# ---------------------------------------------------------------------------
# MIGRATION GUIDE
# ---------------------------------------------------------------------------

# BEFORE (Manual Tool Selection):
# ------------------------------------------------------------------------
# [gcode_macro _TX1]
# gcode:
#     {% set GROUP = params.GROUP|default("T0")|string %}
#
#     # Manual tool selection
#     {% if GROUP == "T4" %}
#         SELECT_TOOL T=4
#     {% elif GROUP == "T6" %}
#         SELECT_TOOL T=4  # Same tool, different lane
#     {% endif %}
#
#     # Temperature logic
#     M109 S240
#
#     # Load filament
#     LOAD_NOZZLE

# AFTER (Bridge Integration):
# ------------------------------------------------------------------------
# [gcode_macro _TX1]
# gcode:
#     {% set GROUP = params.GROUP|default("T0")|string %}
#     {% set LANE = "lane" ~ GROUP[1:] %}
#
#     # Bridge handles tool logic automatically
#     AFC_BRIDGE_PREPARE_LANE LANE={LANE}
#
#     # Temperature logic (unchanged)
#     M109 S240
#
#     # Load filament (unchanged)
#     LOAD_NOZZLE
#
#     # Bridge finalizes
#     AFC_BRIDGE_LANE_LOADED LANE={LANE}

# KEY DIFFERENCES:
# ------------------------------------------------------------------------
# 1. No manual tool selection needed
#    - Bridge auto-detects if tool change required
#    - Only changes tools when extruder differs
#
# 2. Automatic dock/pickup for OpenAMS
#    - If dock_when_swap=True, bridge handles it
#    - T4 lane4?lane6: Dock before load, pickup after
#
# 3. Tool verification built-in
#    - Uses detection_pin to verify correct tool
#    - Fails fast if wrong tool detected
#
# 4. Single source of configuration
#    - Tool offsets defined in [tool TX]
#    - Extruder mapping defined in [tool TX]
#    - Lane uses [AFC_lane] extruder field
#    - Bridge discovers relationships automatically


# ---------------------------------------------------------------------------
# TESTING CHECKLIST
# ---------------------------------------------------------------------------

# 1. Verify Bridge Initialization
#    Run: AFC_BRIDGE_STATUS
#    Check: All lanes are mapped to correct tools
#
# 2. Test Same-Tool Lane Swap (e.g., lane4?lane6, both on extruder4)
#    Expected with dock_when_swap=False:
#      - No tool change
#      - Direct lane swap
#    Expected with dock_when_swap=True:
#      - Tool docks before load
#      - Tool picks up after load
#
# 3. Test Different-Tool Change (e.g., lane4?lane0, extruder4?extruder)
#    Expected:
#      - SELECT_TOOL automatically called
#      - Tool offsets applied
#      - Detection verified (if enabled)
#
# 4. Test Tool Detection
#    Reboot with tool mounted
#    Check klippy.log: "Toolchanger: Detected tool at startup: T4"
#    Run: AFC_BRIDGE_STATUS
#    Verify: Active and Detected tool match