# AFC + Toolchanger Bridge Macros
#
# This file provides macros for AFC with klipper-toolchanger-easy integration.
# Follows the EXACT same pattern as AFC_oams_macros.cfg:
# - One macro per extruder/tool (not per lane)
# - GROUP parameter determines which lane to load
# - Base + wrapper structure
#
# STRUCTURE:
# - SAFE_UNLOAD_FILAMENT: Base unload macro (takes parameters)
# - SAFE_UNLOAD_FILAMENT4/5: One wrapper per extruder/tool
# - _TX: Base load macro (takes parameters)
# - _TX4/_TX5: One wrapper per extruder/tool
#
# FEATURES:
# - Automatic tool change detection via AFC_toolchanger_bridge
# - Automatic docking for OpenAMS units (dock_when_swap_extruders)
# - Tool cutting support (tool_cut)
# - Smart temperature management (compatible with _oams_smart_temp_settings)
# - One macro per extruder handles all its lanes


# ═══════════════════════════════════════════════════════════════════════════
# BASE UNLOAD MACRO
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro SAFE_UNLOAD_FILAMENT]
variable_pause_triggered: False
variable_retry: 0

gcode:
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set TOOL_NUM = params.TOOL|default("0")|string %}
    {% set LANE = params.LANE|default("")|string %}
    {% set CACHE = params.CACHE|default("_toolchanger_temp_cache")|string %}
    {% set LED_NAME = params.LED|default("AFC_indicator")|string %}

    {% set UNLOAD_SPEED = 1000 %}
    {% set ADDITIONAL_UNLOAD_SPEED = 5000 %}
    {% set ADDITIONAL_TIME_ON = 2.0 %}
    {% set ADDITIONAL_EXTRUSION_AMOUNT = ADDITIONAL_UNLOAD_SPEED / 60.0 * (ADDITIONAL_TIME_ON + 1.0) %}

    # Read values from AFC_extruder config
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set extrusion_unload_length = afc_extruder.tool_stn %}

    # Get current temperature
    {% set current_target_temp = printer.extruder.target|int %}
    {% set temp = current_target_temp %}

    # Check if smart temperature is enabled
    {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
        # Smart temp enabled: Get temperature from loaded lane
        {% set extruder_obj = 'AFC_extruder ' ~ EXTRUDER %}
        {% if extruder_obj in printer and 'lane_loaded' in printer[extruder_obj] %}
            {% set loaded_lane = printer[extruder_obj]['lane_loaded']|default('', true)|string %}
            {% if loaded_lane %}
                {% set lane_obj = "AFC_lane " ~ loaded_lane %}
                {% if lane_obj in printer and 'extruder_temp' in printer[lane_obj] %}
                    {% set temp = printer[lane_obj]['extruder_temp']|int %}
                    {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                        RESPOND MSG="[DEBUG] SAFE_UNLOAD_FILAMENT ({EXTRUDER}) using lane temp: {temp}C for {loaded_lane}"
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}

        # Heat to the temp
        M104 S{temp}
        M117 Nozzle heating to {temp}C...
        {action_respond_info("Nozzle heating to %dC..." % temp)}
        {% if temp < 210 %}
            M109 S210
        {% else %}
            M109 S{temp}
        {% endif %}
    {% else %}
        # Smart temp disabled or not available - use current temp
        {% if printer.print_stats.state not in ["printing", "paused"] and temp < 210 %}
            {% set temp = 240 %}
            M104 S{temp}
            M117 Heating to default {temp}C...
            {action_respond_info("Heating to default %dC..." % temp)}
            M109 S{temp}
        {% else %}
            M117 Unloading at current temp {temp}C...
        {% endif %}
    {% endif %}

    # Cache the temp for use during load
    {% if CACHE in printer %}
        SET_GCODE_VARIABLE MACRO={CACHE} VARIABLE=old_temp VALUE={temp}
    {% endif %}

    # Standard AFC unload sequence
    SET_STEPPER_ENABLE STEPPER={EXTRUDER} ENABLE=1
    M83
    G92 E0
    G1 E-{retract_length}

    # Cut if enabled (handled by bridge in prepare_lane, but manual unload needs this)
    {% if printer.AFC.tool_cut %}
        AFC_CUT
        M400
    {% endif %}

    SET_GCODE_OFFSET X=0 Y=0 Z=0
    M83
    G92 E0
    G1 E-90 F{UNLOAD_SPEED}
    M400
    G1 E-{ADDITIONAL_EXTRUSION_AMOUNT} F{ADDITIONAL_UNLOAD_SPEED}
    G4 P1000

    # Call AFC's built-in unload if LANE provided
    {% if LANE %}
        TOOL_UNLOAD LANE={LANE}
    {% endif %}

    M400

    {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
        M104 S0
        M400
    {% endif %}

    {% if LED_NAME %}
        SET_LED LED={LED_NAME} INDEX=1 RED=1 GREEN=0 BLUE=0
    {% endif %}


# ═══════════════════════════════════════════════════════════════════════════
# SPECIFIC UNLOAD WRAPPERS - ONE PER EXTRUDER/TOOL
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro SAFE_UNLOAD_FILAMENT1]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder4 TOOL=4 CACHE=_toolchanger_temp_cache_t4 LED=AFC_Sndicator {rawparams}

[gcode_macro SAFE_UNLOAD_FILAMENT2]
gcode:
    SAFE_UNLOAD_FILAMENT EXTRUDER=extruder5 TOOL=5 CACHE=_toolchanger_temp_cache_t5 LED=AFC_Tndicator {rawparams}


# ═══════════════════════════════════════════════════════════════════════════
# BASE LOAD MACRO (_TX)
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _TX]
variable_pause_triggered: False

gcode:
    {% set GROUP = params.GROUP %}
    {% set EXTRUDER = params.EXTRUDER|default("extruder")|string %}
    {% set TOOL_NUM = params.TOOL|default("0")|string %}
    {% set CACHE = params.CACHE|default("_toolchanger_temp_cache")|string %}
    {% set LED_NAME = params.LED|default("AFC_indicator")|string %}

    # Parse GROUP to extract lane number (T4 -> lane4, T6 -> lane6, etc.)
    {% set lane_num = GROUP.replace('T', '') if 'T' in GROUP else GROUP %}
    {% set LANE = "lane" ~ lane_num %}

    # Read values from AFC_extruder config
    {% set afc_extruder = printer['AFC_extruder ' ~ EXTRUDER] %}
    {% set hotend_meltzone_compensation = printer["gcode_macro _oams_macro_variables"].hotend_meltzone_compensation if 'gcode_macro _oams_macro_variables' in printer else 0 %}
    {% set retract_length = printer["gcode_macro _AFC_CUT_TIP_VARS"].retract_length %}
    {% set extrusion_reload_length = afc_extruder.tool_stn_unload %}
    {% set reload_speed = (afc_extruder.tool_load_speed * 10 * 60)|int %}
    {% set RELOAD_LENGTH = (extrusion_reload_length + retract_length + hotend_meltzone_compensation) %}

    {% set current_target_temp = printer.extruder.target|int %}
    STOP_TOOL_CRASH_DETECTION

    {% if printer.toolhead.homed_axes != 'xyz' %}
        RESPOND TYPE=command MSG='Homing'
        G28
    {% endif %}

    {% if printer.exclude_object.current_object not in printer.exclude_object.excluded_objects %}
        RESPOND TYPE=command MSG='Loading {GROUP} (Lane: {LANE}) on {EXTRUDER}'

        # Calculate temperature
        {% set purge_temp = current_target_temp %}

        # Check if smart temperature is enabled
        {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
            # Smart temp enabled: Calculate optimal purge temperature
            {% set old_temp = printer["gcode_macro " ~ CACHE].old_temp|default(240)|int if CACHE in printer else 240 %}
            {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] _TX ({CACHE}): Retrieved cached old_temp: {old_temp}C"
            {% endif %}

            # Get new lane temp
            {% set new_temp = 240 %}
            {% set lane_obj = "AFC_lane " ~ LANE %}
            {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] _TX: Looking for new lane: {lane_obj}"
            {% endif %}
            {% if lane_obj in printer %}
                {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX: Found {lane_obj}"
                {% endif %}
                {% if 'extruder_temp' in printer[lane_obj] %}
                    {% set new_temp = printer[lane_obj]['extruder_temp']|int %}
                    {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                        RESPOND MSG="[DEBUG] _TX: New temp: {new_temp}C"
                    {% endif %}
                {% endif %}
            {% else %}
                {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                    RESPOND MSG="[DEBUG] _TX: {lane_obj} not found, using default 240C"
                {% endif %}
            {% endif %}

            # Calculate max temperature for purge
            {% set purge_temp = old_temp if old_temp > new_temp else new_temp %}
            {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] _TX ({CACHE}): Calculated purge temp: {purge_temp}C (max of {old_temp}C and {new_temp}C)"
            {% endif %}
        {% else %}
            # Smart temp disabled: Don't change temperature - use current temp
            {% set purge_temp = current_target_temp %}
            {% if 'gcode_macro _oams_debug_settings' in printer and printer["gcode_macro _oams_debug_settings"].debug_enabled %}
                RESPOND MSG="[DEBUG] _TX ({CACHE}): Smart temp disabled, using current temp: {purge_temp}C"
            {% endif %}
        {% endif %}

        # ═══════════════════════════════════════════════════════════════════════
        # BRIDGE INTEGRATION: Prepare lane change
        # ═══════════════════════════════════════════════════════════════════════
        # This handles:
        # - Tool docking (if dock_when_swap enabled for this extruder)
        # - Tool changing (if different extruder)
        # - Tool cutting (if tool_cut=True)

        AFC_BRIDGE_PREPARE_LANE LANE={LANE}

        # ═══════════════════════════════════════════════════════════════════════
        # Temperature and Loading
        # ═══════════════════════════════════════════════════════════════════════

        # Heat to purge temp
        {% if 'gcode_macro _oams_smart_temp_settings' in printer and printer["gcode_macro _oams_smart_temp_settings"].enable_smart_temp %}
            M104 S{purge_temp}
            M117 Heating to {purge_temp}C for {GROUP}...
            {action_respond_info("Heating to %dC for %s..." % (purge_temp, GROUP))}
            {% if purge_temp < 210 %}
                M109 S210
            {% else %}
                M109 S{purge_temp}
            {% endif %}
        {% else %}
            # Smart temp disabled: If not printing and temp too low, heat to default
            {% if printer.print_stats.state not in ["printing", "paused"] and purge_temp < 210 %}
                {% set purge_temp = 240 %}
                M104 S{purge_temp}
                M117 Heating to default {purge_temp}C for {GROUP}...
                {action_respond_info("Heating to default %dC for %s..." % (purge_temp, GROUP))}
                M109 S{purge_temp}
            {% else %}
                M117 Loading {GROUP} at current temp {purge_temp}C...
                {action_respond_info("Loading %s at current temp %dC..." % (GROUP, purge_temp))}
            {% endif %}
        {% endif %}

        # Load the new spool using AFC
        TOOL_LOAD LANE={LANE}
        M400
        G4 P500

        # ═══════════════════════════════════════════════════════════════════════
        # BRIDGE INTEGRATION: Finalize lane change
        # ═══════════════════════════════════════════════════════════════════════
        # This handles:
        # - Tool pickup (if we docked it earlier)
        # - Purge (if auto_purge=True and purge_before_pickup configured)
        # - Tool verification (if verify_tool_mounted=True)

        AFC_BRIDGE_LANE_LOADED LANE={LANE}

        {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
            M104 S0
            M400
        {% endif %}
    {% endif %}

    # Set LED and enable crash detection
    {% if LED_NAME %}
        SET_LED LED={LED_NAME} INDEX=1 RED=0 GREEN=1 BLUE=0
    {% endif %}
    START_TOOL_CRASH_DETECTION


# ═══════════════════════════════════════════════════════════════════════════
# SPECIFIC LOAD WRAPPERS - ONE PER EXTRUDER/TOOL
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _TX1]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder4 TOOL=4 CACHE=_toolchanger_temp_cache_t4 LED=AFC_Sndicator

[gcode_macro _TX2]
gcode:
    {% set GROUP = params.GROUP %}
    _TX GROUP={GROUP} EXTRUDER=extruder5 TOOL=5 CACHE=_toolchanger_temp_cache_t5 LED=AFC_Tndicator


# ═══════════════════════════════════════════════════════════════════════════
# TEMPERATURE CACHE MACROS - ONE PER EXTRUDER/TOOL
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro _toolchanger_temp_cache_t4]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed

[gcode_macro _toolchanger_temp_cache_t5]
variable_target_temp: 240
variable_old_temp: 240
gcode:
    # This macro just holds variables, no gcode needed


# ═══════════════════════════════════════════════════════════════════════════
# DIAGNOSTIC COMMANDS
# ═══════════════════════════════════════════════════════════════════════════

[gcode_macro CHECK_BRIDGE_STATUS]
description: Show AFC toolchanger bridge status and mappings
gcode:
    AFC_BRIDGE_STATUS

[gcode_macro CHECK_LANE_TOOL]
description: Check which tool a lane uses
gcode:
    {% set LANE = params.LANE|default("lane0")|string %}
    AFC_BRIDGE_GET_TOOL LANE={LANE}


# ═══════════════════════════════════════════════════════════════════════════
# EXAMPLE: Adding More Extruders/Tools
# ═══════════════════════════════════════════════════════════════════════════
#
# To add additional extruders/tools, follow this pattern (SAME AS AFC_oams_macros.cfg):
#
# 1. Create a temperature cache macro:
#    [gcode_macro _toolchanger_temp_cache_t6]
#    variable_target_temp: 240
#    variable_old_temp: 240
#    gcode:
#
# 2. Create wrapper macros:
#    [gcode_macro SAFE_UNLOAD_FILAMENT6]
#    gcode:
#        SAFE_UNLOAD_FILAMENT EXTRUDER=extruder6 TOOL=6 CACHE=_toolchanger_temp_cache_t6 LED=AFC_indicator {rawparams}
#
#    [gcode_macro _TX6]
#    gcode:
#        {% set GROUP = params.GROUP %}
#        _TX GROUP={GROUP} EXTRUDER=extruder6 TOOL=6 CACHE=_toolchanger_temp_cache_t6 LED=AFC_indicator
#
# ONE macro per extruder handles ALL lanes on that extruder!
# - _TX4 handles: lane4, lane6, lane8, etc. (all lanes on extruder4)
# - _TX5 handles: lane5, lane7, lane9, etc. (all lanes on extruder5)
# - GROUP parameter determines which lane: _TX4 GROUP=T6 loads lane6
#
# Parameters explanation:
# - EXTRUDER: The Klipper extruder name (extruder4, extruder5, etc.)
# - TOOL: The tool number for SELECT_TOOL command (4, 5, etc.)
# - CACHE: The temperature cache macro name for this extruder/tool
# - LED: The LED indicator name for this extruder/tool (optional)
# - GROUP: Which lane to load (T4, T6, T8, etc.) - determines lane number


# ═══════════════════════════════════════════════════════════════════════════
# USAGE IN LANE CONFIGS
# ═══════════════════════════════════════════════════════════════════════════
#
# EXACT SAME PATTERN AS AFC_oams_macros.cfg:
#
# [AFC_lane lane4]
# unit: AMS_1:1
# extruder: extruder4
# map: T4
# custom_load_cmd: _TX4 GROUP=T4
# custom_unload_cmd: SAFE_UNLOAD_FILAMENT4
#
# [AFC_lane lane6]
# unit: AMS_1:2
# extruder: extruder4          # Same extruder as lane4!
# map: T6
# custom_load_cmd: _TX4 GROUP=T6    # Same macro, different GROUP!
# custom_unload_cmd: SAFE_UNLOAD_FILAMENT4
#
# [AFC_lane lane5]
# unit: AMS_2:1
# extruder: extruder5
# map: T5
# custom_load_cmd: _TX5 GROUP=T5
# custom_unload_cmd: SAFE_UNLOAD_FILAMENT5
#
# ALTERNATIVE: Use AFC_CHANGE_LANE directly (no custom commands needed):
# [AFC_lane lane4]
# unit: AMS_1:1
# extruder: extruder4
# map: T4
# # No custom_load_cmd or custom_unload_cmd!


# ═══════════════════════════════════════════════════════════════════════════
# TESTING CHECKLIST
# ═══════════════════════════════════════════════════════════════════════════
#
# 1. Verify Bridge Initialization
#    Run: AFC_BRIDGE_STATUS
#    Check: All lanes are mapped to correct tools
#
# 2. Test Same-Tool Lane Swap (e.g., lane4→lane6, both on extruder4)
#    Run: _TX4 GROUP=T6
#    Expected with dock_when_swap_extruders containing extruder4:
#      - Tool docks before load
#      - Filament loads
#      - Bridge calls purge (if auto_purge=True)
#      - Tool picks up
#    Expected without extruder4 in dock_when_swap_extruders:
#      - No tool change
#      - Direct lane swap
#
# 3. Test Different-Tool Change (e.g., lane4→lane5, extruder4→extruder5)
#    From lane4: Run SAFE_UNLOAD_FILAMENT4
#    Then run: _TX5 GROUP=T5
#    Expected:
#      - SELECT_TOOL automatically called
#      - Tool offsets applied
#      - Detection verified (if enabled)
#
# 4. Test Multiple Lanes on Same Tool
#    Run: _TX4 GROUP=T4  (loads lane4)
#    Run: _TX4 GROUP=T6  (loads lane6 on same tool)
#    Expected: Bridge handles dock/pickup based on dock_when_swap_extruders