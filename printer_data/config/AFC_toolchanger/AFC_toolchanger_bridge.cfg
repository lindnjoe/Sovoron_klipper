# AFC Toolchanger Bridge Configuration
#
# This module bridges AFC (Armored Filament Changer) with klipper-toolchanger-easy
# to provide seamless integration between filament management and physical tools.
#
# WHAT THIS DOES:
# - Auto-discovers which lanes connect to which tools (via extruder mapping)
# - Automatically handles tool changes when switching between different extruders
# - Optionally docks/picks up tools during same-tool lane swaps (for OpenAMS safety)
# - Verifies correct tool is mounted via detection pins
# - Simplifies your macros by handling toolchanger coordination
#
# CONFIGURATION GUIDE:
#
# 1. Basic Setup (Most Users):
#    - enable: True
#    - auto_tool_change: True
#    - dock_when_swap: False (unless you have OpenAMS on toolheads)
#
# 2. OpenAMS on Toolheads:
#    - dock_when_swap: True  (docks tool before loading new lane on same extruder)
#
# 3. Advanced:
#    - auto_purge: True (automatically runs purge_command after lane changes)
#    - verify_tool_mounted: True (checks detection_pin after tool changes)

[AFC_toolchanger_bridge]

# -------------------------------------------------------------------------------
# BASIC SETTINGS
# -------------------------------------------------------------------------------

# Enable the bridge module
# Set to False to disable all bridge functionality
# Default: True
enable: True

# Automatically call SELECT_TOOL when lane change requires different tool
# If False, you must manually handle tool changes in your macros
# Default: True
auto_tool_change: True

# -------------------------------------------------------------------------------
# DOCK BEHAVIOR (OpenAMS Specific)
# -------------------------------------------------------------------------------

# Dock tool during same-extruder lane swaps - PER EXTRUDER CONFIGURATION
#
# Specify which extruders should dock the tool during lane swaps on the same extruder.
# This allows mixed configurations where some tools have OpenAMS (need docking) and
# others don't (can stay mounted).
#
# Format: Comma-separated list of extruder names
# Example: extruder4, extruder5
# Leave empty to disable docking for all extruders
#
# When configured for an extruder (e.g., extruder4):
#   Swapping lane4?lane6 (both on extruder4/T4):
#     1. Cut filament (if tool_cut=True)
#     2. Dock T4 (tool moved out of the way)
#     3. Unload lane4
#     4. Load lane6 into extruder4
#     5. Pickup T4 (tool back in position)
#
# When NOT configured for an extruder:
#   Swapping lanes on that extruder:
#     1. Unload old lane
#     2. Load new lane (tool stays mounted)
#
# USE CASES:
# - extruder4, extruder5: These have OpenAMS units (need docking)
# - extruder, extruder1: These are standard (no docking needed)
#
# Default: Empty (no extruders dock on swap)
dock_when_swap_extruders: extruder4, extruder5

# DEPRECATED: Global dock_when_swap setting
# Use dock_when_swap_extruders instead for per-extruder control
# Only used as fallback if dock_when_swap_extruders is empty
# Default: False
#dock_when_swap: False

# -------------------------------------------------------------------------------
# TOOL CUTTING SETTINGS
# -------------------------------------------------------------------------------

# Enable tool cutting before unloading during same-tool lane swaps
#
# When True (and extruder in dock_when_swap_extruders):
#   Sequence for lane4?lane6 swap:
#     1. AFC_CUT - severs filament at toolhead
#     2. Retract tool_stn_unload - pulls cut filament back
#     3. Dock T4 - tool moved out of way
#     4. Unload lane4 - filament extracted from hub/buffer
#     5. Load lane6 - new filament fed to hub/buffer
#     6. Extrude tool_stn - pushes new filament into position
#     7. Purge - purges configured amount
#     8. Pickup T4 - tool back in position
#
# When False:
#   No cutting, filament is retracted without being severed
#
# USE CASES:
# - True: You have a filament cutter on toolhead (cleaner lane swaps)
# - False: No cutter, or prefer not to cut during swaps
#
# NOTES:
# - Only applies to same-tool lane swaps (not tool changes)
# - Requires extruder to be in dock_when_swap_extruders list
# - Cut happens FIRST, before any unloading
# - Uses AFC extruder's tool_stn and tool_stn_unload settings
#
# Default: False
tool_cut: True

# GCode command to run for cutting filament
# Only used if tool_cut=True
# Can be AFC_CUT, or any custom macro
# Default: AFC_CUT
tool_cut_command: AFC_CUT

# Post-cut retract amount (optional - reads from AFC extruder if not set)
# After cutting, retracts this distance to pull cut filament back
# If not specified, bridge reads tool_stn_unload from AFC_extruder config
# Default: Read from AFC extruder
#tool_stn_unload: 20.0

# Pre-purge extrude amount (optional - reads from AFC extruder if not set)
# After loading new lane, extrudes this distance before purging
# If not specified, bridge reads tool_stn from AFC_extruder config
# Default: Read from AFC extruder
#tool_stn: 80.0

# -------------------------------------------------------------------------------
# VERIFICATION SETTINGS
# -------------------------------------------------------------------------------

# Verify correct tool is mounted after SELECT_TOOL commands
# Uses toolchanger detection_pin to confirm the right tool is on shuttle
# Requires [tool TX] sections to have detection_pin defined
# Default: True
verify_tool_mounted: True

# How long to wait (seconds) for detection_pin to stabilize after tool change
# Increase if you get false verification failures
# Default: 1.0
verify_timeout: 1.0

# -------------------------------------------------------------------------------
# PURGE SETTINGS
# -------------------------------------------------------------------------------

# Automatically run purge command after lane changes
# Useful if you want bridge to handle the entire sequence
# If False, your macros handle purging
# Default: False
auto_purge: True

# GCode command to run for purging
# Only used if auto_purge=True
# Can be a macro like LOAD_NOZZLE, or any GCode command
# Default: LOAD_NOZZLE
purge_command: PURGE_NOZZLE

# Purge before or after tool pickup
#
# When True (purge_before_pickup):
#   1. Dock tool
#   2. Load filament
#   3. Purge (tool still docked)  ? Purge happens here
#   4. Pickup tool
#
# When False (standard):
#   1. Dock tool
#   2. Load filament
#   3. Pickup tool
#   4. Purge (tool mounted)  ? Purge happens here
#
# USE CASES:
# - True: Your purge bucket/brush is accessible when tool is docked
#         (Common for OpenAMS setups where purge happens in dock area)
# - False: Your purge bucket/brush requires tool to be mounted
#          (Standard toolchanger with purge bucket at front)
#
# Default: False
purge_before_pickup: True

# -------------------------------------------------------------------------------
# ADVANCED SETTINGS (Optional)
# -------------------------------------------------------------------------------

# Override toolchanger's tool change speed (mm/min)
# Leave commented to use toolchanger's configured speed
# Only affects SELECT_TOOL commands issued by bridge
#tool_change_speed: 55000

# Override toolchanger's path speed (mm/min)
# Leave commented to use toolchanger's configured path_speed
# Only affects dock/pickup movements
#path_speed: 2000


# -------------------------------------------------------------------------------
# USAGE EXAMPLES
# -------------------------------------------------------------------------------

# OPTION 1: Use bridge helper commands in your existing macros
# ---------------------------------------------------------------
# [gcode_macro _TX1]
# gcode:
#     {% set LANE = params.LANE|default("")|string %}
#
#     # Bridge handles tool preparation
#     AFC_BRIDGE_PREPARE_LANE LANE={LANE}
#
#     # Your existing load logic
#     LOAD_NOZZLE
#
#     # Bridge handles tool finalization
#     AFC_BRIDGE_LANE_LOADED LANE={LANE}

# OPTION 2: Use simplified lane change command (future)
# -------------------------------------------------------
# AFC_CHANGE_LANE FROM=lane4 TO=lane6
# (Bridge handles everything: unload, dock, tool change, load, pickup, purge)

# OPTION 3: Query bridge status
# ---------------------------------------------------------------
# AFC_BRIDGE_STATUS              # Show all mappings and current state
# AFC_BRIDGE_GET_TOOL LANE=lane4 # Check which tool a lane needs


# -------------------------------------------------------------------------------
# TROUBLESHOOTING
# -------------------------------------------------------------------------------

# Check klippy.log for bridge initialization:
#   "AFC_toolchanger_bridge: Mapped extruder4 ? Tool T4 (T4)"
#   "AFC_toolchanger_bridge: Lane lane4 ? T4 (T4)"
#   "AFC_toolchanger_bridge: Ready with X lanes mapped"

# Run AFC_BRIDGE_STATUS to see all discovered mappings

# If verification fails:
#   - Check [tool TX] has detection_pin defined
#   - Increase verify_timeout
#   - Check detection_pin wiring
#   - Check klippy.log for "Toolchanger: Detected tool at startup" messages

# If tool doesn't change when expected:
#   - Check auto_tool_change: True
#   - Verify lane's extruder matches a [tool TX] extruder
#   - Check AFC_BRIDGE_STATUS to see lane?tool mapping

# If OpenAMS collides with mounted tool:
#   - Set dock_when_swap: True
#   - Verify toolchanger has require_tool_present: False